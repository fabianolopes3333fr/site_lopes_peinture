{% extends 'base_dashboard.html' %} 
{% load static tailwind_tags %} 
{% block title %}Supprimer {{ devis.reference }} - LOPES PEINTURE{% endblock %} 
{% block extra_css %}
{% tailwind_css %}
{% endblock %} 
{% block content %}
<div class="p-6 max-w-4xl mx-auto">
  <!-- Header avec navigation -->
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-4">
      <a
        href="{% url 'projects:devis_detail' pk=devis.pk %}"
        class="text-gray-600 hover:text-blue-600 transition-colors duration-200"
        title="Retour au devis"
      >
        <i class="fas fa-arrow-left text-lg"></i>
      </a>
      <h1 class="text-3xl font-bold text-red-600 flex items-center gap-3">
        <i class="fas fa-exclamation-triangle"></i>
        Supprimer le Devis
      </h1>
    </div>
    <p class="text-gray-600">
      Vous √™tes sur le point de supprimer d√©finitivement ce devis. Cette action peut avoir des
      cons√©quences importantes.
    </p>
  </div>

  <!-- Alertes critiques selon le statut -->
  {% if devis.status == 'accepte' %}
  <div class="error-banner">
    <div class="flex items-start">
      <i class="fas fa-ban text-red-600 mt-1 mr-3"></i>
      <div>
        <h3 class="font-medium text-red-800 mb-1">‚ùå SUPPRESSION INTERDITE</h3>
        <p class="text-sm text-red-700">
          Ce devis a √©t√© <strong>accept√© par le client</strong> et constitue un engagement
          contractuel. La suppression pourrait avoir des implications l√©gales.
        </p>
        <p class="text-sm text-red-700 mt-2">
          <strong>Actions recommand√©es :</strong> Annulez le devis ou cr√©ez un avoir plut√¥t que de
          le supprimer.
        </p>
      </div>
    </div>
  </div>
  {% endif %} {% if devis.status == 'envoye' %}
  <div class="warning-banner">
    <div class="flex items-start">
      <i class="fas fa-exclamation-triangle text-orange-600 mt-1 mr-3"></i>
      <div>
        <h3 class="font-medium text-orange-800 mb-1">‚ö†Ô∏è ATTENTION - Devis envoy√© au client</h3>
        <p class="text-sm text-orange-700">
          Ce devis a √©t√© envoy√© au client le {{ devis.sent_at|date:"d/m/Y √† H:i" }}. Sa suppression
          peut cr√©er de la confusion c√¥t√© client.
        </p>
        <p class="text-sm text-orange-700 mt-2">
          <strong>Consid√©rez plut√¥t :</strong> Cr√©er une nouvelle version ou marquer comme "annul√©".
        </p>
      </div>
    </div>
  </div>
  {% endif %} {% if devis.is_expired and devis.status == 'envoye' %}
  <div class="info-banner">
    <div class="flex items-start">
      <i class="fas fa-clock text-blue-600 mt-1 mr-3"></i>
      <div>
        <h3 class="font-medium text-blue-800 mb-1">‚ÑπÔ∏è Devis expir√©</h3>
        <p class="text-sm text-blue-700">
          Ce devis a expir√© le {{ devis.date_expiry|date:"d/m/Y" }}. La suppression est moins
          probl√©matique mais peut affecter l'historique client.
        </p>
      </div>
    </div>
  </div>
  {% endif %} {% if devis.status == 'brouillon' %}
  <div class="info-banner">
    <div class="flex items-start">
      <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
      <div>
        <h3 class="font-medium text-blue-800 mb-1">‚úÖ Devis en brouillon</h3>
        <p class="text-sm text-blue-700">
          Ce devis est encore en brouillon et n'a pas √©t√© envoy√© au client. Sa suppression aura un
          impact minimal.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Aper√ßu du devis √† supprimer -->
  <div class="devis-preview mb-8">
    <div class="flex items-start justify-between mb-4">
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-2">
          <h2 class="text-xl font-semibold text-gray-900">{{ devis.title }}</h2>
          <span
            class="status-badge {% if devis.status == 'brouillon' %}bg-gray-100 text-gray-800 {% elif devis.status == 'envoye' %}bg-blue-100 text-blue-800 {% elif devis.status == 'accepte' %}bg-green-100 text-green-800 {% elif devis.status == 'refuse' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
          >
            {{ devis.get_status_display }}
          </span>
          {% if devis.version > 1 %}
          <span class="version-badge">
            <i class="fas fa-code-branch mr-1"></i>
            Version {{ devis.version }}
          </span>
          {% endif %}
        </div>

        <p class="text-gray-600 mb-3">
          {{ devis.description|truncatewords:20|default:"Aucune description" }}
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mb-4">
          <div>
            <span class="text-gray-500">R√©f√©rence:</span>
            <span class="font-mono ml-2">{{ devis.reference }}</span>
          </div>
          <div>
            <span class="text-gray-500">Projet:</span>
            <a
              href="{% url 'projects:detail' pk=devis.project.pk %}"
              class="text-blue-600 hover:text-blue-700 ml-2"
            >
              {{ devis.project.title|truncatechars:30 }}
            </a>
          </div>
          <div>
            <span class="text-gray-500">Client:</span>
            <span class="ml-2"
              >{{ devis.project.user.get_full_name|default:devis.project.user.username }}</span
            >
          </div>
          <div>
            <span class="text-gray-500">Cr√©√© le:</span>
            <span class="ml-2">{{ devis.created_at|date:"d/m/Y √† H:i" }}</span>
          </div>
          {% if devis.sent_at %}
          <div>
            <span class="text-gray-500">Envoy√© le:</span>
            <span class="ml-2">{{ devis.sent_at|date:"d/m/Y √† H:i" }}</span>
          </div>
          {% endif %} {% if devis.date_expiry %}
          <div>
            <span class="text-gray-500">Expire le:</span>
            <span class="ml-2 {% if devis.is_expired %}text-red-600 font-medium{% endif %}">
              {{ devis.date_expiry|date:"d/m/Y" }}
            </span>
          </div>
          {% endif %}
        </div>

        <!-- Montant financier -->
        <div class="financial-impact">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-medium text-gray-900 mb-1">Montant du devis</h4>
              <div class="text-sm text-gray-600">
                Total HT: <span class="font-mono">{{ devis.total_ht|floatformat:2 }}‚Ç¨</span> ‚Ä¢ Total
                TTC:
                <span class="font-mono font-bold text-lg text-red-600"
                  >{{ devis.total|floatformat:2 }}‚Ç¨</span
                >
              </div>
            </div>
            <div class="text-right">
              <i class="fas fa-euro-sign text-red-600 text-2xl"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Impact client -->
  {% if devis.status != 'brouillon' %}
  <div class="client-impact">
    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
      <i class="fas fa-user-times text-yellow-600"></i>
      Impact sur le client
    </h3>

    <div class="space-y-2 text-sm">
      {% if devis.status == 'envoye' %}
      <div class="flex items-start gap-2">
        <i class="fas fa-envelope text-yellow-600 mt-1"></i>
        <span>Le client a re√ßu ce devis et pourrait s'attendre √† une r√©ponse</span>
      </div>
      {% endif %} {% if devis.status == 'accepte' %}
      <div class="flex items-start gap-2">
        <i class="fas fa-handshake text-red-600 mt-1"></i>
        <span><strong>Le client a accept√© ce devis</strong> - Engagement contractuel existant</span>
      </div>
      {% endif %}

      <div class="flex items-start gap-2">
        <i class="fas fa-history text-yellow-600 mt-1"></i>
        <span>L'historique des √©changes avec le client sera perdu</span>
      </div>

      <div class="flex items-start gap-2">
        <i class="fas fa-file-pdf text-yellow-600 mt-1"></i>
        <span>Les liens PDF envoy√©s au client ne fonctionneront plus</span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Implications l√©gales -->
  {% if devis.status == 'accepte' %}
  <div class="legal-warning">
    <h3 class="text-lg font-semibold text-red-800 mb-3 flex items-center gap-2">
      <i class="fas fa-gavel text-red-600"></i>
      ‚öñÔ∏è Implications L√©gales
    </h3>

    <div class="space-y-2 text-sm text-red-700">
      <div class="flex items-start gap-2">
        <i class="fas fa-exclamation-triangle text-red-600 mt-1"></i>
        <span
          ><strong>Engagement contractuel :</strong> Ce devis accept√© constitue un contrat avec le
          client</span
        >
      </div>

      <div class="flex items-start gap-2">
        <i class="fas fa-balance-scale text-red-600 mt-1"></i>
        <span
          ><strong>Obligations l√©gales :</strong> Vous devez conserver les preuves de transaction
          pendant 10 ans</span
        >
      </div>

      <div class="flex items-start gap-2">
        <i class="fas fa-shield-alt text-red-600 mt-1"></i>
        <span
          ><strong>Protection client :</strong> La suppression peut √™tre consid√©r√©e comme de la
          mauvaise foi</span
        >
      </div>

      <div class="bg-red-200 border border-red-300 rounded p-3 mt-3">
        <p class="font-medium">üö® RECOMMANDATION L√âGALE</p>
        <p class="text-xs mt-1">
          Consultez votre service juridique avant de supprimer un devis accept√©. Pr√©f√©rez
          l'annulation avec accord √©crit du client.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Conditions de suppression -->
  {% if devis.can_be_deleted %}
  <div class="danger-zone">
    <div class="text-center">
      <i class="fas fa-skull-crossbones text-red-600 text-4xl mb-4"></i>
      <h2 class="text-2xl font-bold text-red-800 mb-4">Zone de Danger</h2>

      <!-- Impact de la suppression -->
      <div class="impact-list text-left">
        <div class="impact-item">
          <div class="impact-icon">
            <i class="fas fa-ban"></i>
          </div>
          <div>
            <h4 class="font-medium text-red-800">Suppression d√©finitive</h4>
            <p class="text-sm text-red-700">
              Le devis sera d√©finitivement supprim√© et ne pourra pas √™tre r√©cup√©r√©.
            </p>
          </div>
        </div>

        <div class="impact-item">
          <div class="impact-icon">
            <i class="fas fa-list"></i>
          </div>
          <div>
            <h4 class="font-medium text-red-800">Items et prestations</h4>
            <p class="text-sm text-red-700">
              Tous les items, prestations et d√©tails financiers seront perdus ({{ devis.items.count
              }} √©l√©ment{{ devis.items.count|pluralize }}).
            </p>
          </div>
        </div>

        <div class="impact-item">
          <div class="impact-icon">
            <i class="fas fa-file-pdf"></i>
          </div>
          <div>
            <h4 class="font-medium text-red-800">Documents g√©n√©r√©s</h4>
            <p class="text-sm text-red-700">
              Les PDF et documents g√©n√©r√©s ne seront plus accessibles.
            </p>
          </div>
        </div>

        <div class="impact-item">
          <div class="impact-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div>
            <h4 class="font-medium text-red-800">Statistiques et rapports</h4>
            <p class="text-sm text-red-700">
              Les donn√©es de ce devis seront exclues des rapports et statistiques.
            </p>
          </div>
        </div>

        {% if devis.status != 'brouillon' %}
        <div class="impact-item">
          <div class="impact-icon">
            <i class="fas fa-bell"></i>
          </div>
          <div>
            <h4 class="font-medium text-red-800">Notification automatique</h4>
            <p class="text-sm text-red-700">
              {% if devis.status == 'accepte' %} La direction sera automatiquement notifi√©e de cette
              suppression critique. {% else %} L'√©quipe sera notifi√©e de cette suppression. {% endif
              %}
            </p>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Formulaire de confirmation -->
      <form method="post" id="delete-form" class="mt-8">
        {% csrf_token %}

        <!-- Confirmations obligatoires -->
        <div class="confirmation-card p-6 mb-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirmations obligatoires</h3>

          <div class="space-y-4 text-left">
            <label class="flex items-start gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="confirm-understand"
                class="checkbox-confirm mt-1"
                required
              />
              <span class="text-sm text-gray-700">
                Je comprends que cette action est <strong>irr√©versible</strong> et que toutes les
                donn√©es seront d√©finitivement perdues.
              </span>
            </label>

            <label class="flex items-start gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="confirm-financial"
                class="checkbox-confirm mt-1"
                required
              />
              <span class="text-sm text-gray-700">
                J'ai v√©rifi√© que ce devis de <strong>{{ devis.total|floatformat:2 }}‚Ç¨</strong> peut
                √™tre supprim√© sans impact financier.
              </span>
            </label>

            {% if devis.status != 'brouillon' %}
            <label class="flex items-start gap-3 cursor-pointer">
              <input type="checkbox" id="confirm-client" class="checkbox-confirm mt-1" required />
              <span class="text-sm text-gray-700">
                J'ai inform√© le client de cette suppression ou confirm√© qu'elle n'aura pas d'impact
                n√©gatif.
              </span>
            </label>
            {% endif %} {% if devis.status == 'accepte' %}
            <label class="flex items-start gap-3 cursor-pointer">
              <input type="checkbox" id="confirm-legal" class="checkbox-confirm mt-1" required />
              <span class="text-sm text-gray-700">
                <strong class="text-red-700">J'ai obtenu l'autorisation de la direction</strong> et
                assum√© les risques l√©gaux de supprimer un devis accept√©.
              </span>
            </label>
            {% endif %}

            <label class="flex items-start gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="confirm-responsibility"
                class="checkbox-confirm mt-1"
                required
              />
              <span class="text-sm text-gray-700">
                J'accepte la pleine responsabilit√© de cette suppression et de ses cons√©quences.
              </span>
            </label>

            <!-- Confirmation par saisie de la r√©f√©rence -->
            <div class="pt-4 border-t border-gray-200">
              <label for="confirm-reference" class="block text-sm font-medium text-gray-700 mb-2">
                Pour confirmer, tapez la r√©f√©rence exacte du devis :
              </label>
              <input
                type="text"
                id="confirm-reference"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent font-mono"
                placeholder="{{ devis.reference }}"
                required
              />
              <p class="text-xs text-gray-500 mt-1">
                R√©f√©rence attendue: <span class="font-mono font-bold">{{ devis.reference }}</span>
              </p>
            </div>

            <!-- Raison de la suppression -->
            <div class="pt-4 border-t border-gray-200">
              <label for="deletion-reason" class="block text-sm font-medium text-gray-700 mb-2">
                Raison de la suppression <span class="text-red-500">*</span>
              </label>
              <select
                id="deletion-reason"
                name="deletion_reason"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                required
              >
                <option value="">S√©lectionnez une raison...</option>
                <option value="erreur_creation">Erreur lors de la cr√©ation</option>
                <option value="doublon">Devis en doublon</option>
                <option value="annulation_client">Annulation par le client</option>
                <option value="erreur_technique">Erreur technique</option>
                <option value="demande_direction">Demande de la direction</option>
                <option value="autre">Autre raison (√† pr√©ciser en commentaire)</option>
              </select>
            </div>

            <!-- Commentaire obligatoire -->
            <div>
              <label for="deletion-comment" class="block text-sm font-medium text-gray-700 mb-2">
                Commentaire explicatif <span class="text-red-500">*</span>
              </label>
              <textarea
                id="deletion-comment"
                name="deletion_comment"
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                placeholder="Expliquez en d√©tail les raisons de cette suppression..."
                required
              ></textarea>
              <p class="text-xs text-gray-500 mt-1">
                Ce commentaire sera conserv√© dans l'audit trail pour tra√ßabilit√©.
              </p>
            </div>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="{% url 'projects:devis_detail' pk=devis.pk %}"
            class="action-btn btn-secondary justify-center"
          >
            <i class="fas fa-times"></i>
            Annuler
          </a>

          {% if devis.status != 'accepte' %}
          <button
            type="button"
            onclick="archiveInstead()"
            class="action-btn btn-primary justify-center"
          >
            <i class="fas fa-archive"></i>
            Archiver plut√¥t
          </button>
          {% endif %}

          <button
            type="submit"
            id="delete-button"
            class="action-btn btn-danger justify-center"
            disabled
          >
            <i class="fas fa-trash"></i>
            <span id="delete-text">Supprimer d√©finitivement</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <!-- Message si suppression non autoris√©e -->
  <div class="text-center">
    <div class="bg-white border border-gray-200 rounded-lg p-8">
      <i class="fas fa-shield-alt text-gray-400 text-4xl mb-4"></i>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">Suppression non autoris√©e</h2>
      <p class="text-gray-600 mb-6">
        Ce devis ne peut pas √™tre supprim√© en raison de son statut ou des r√©glementations en
        vigueur.
      </p>

      <div class="flex justify-center gap-4">
        <a href="{% url 'projects:devis_detail' pk=devis.pk %}" class="action-btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Retour au devis
        </a>

        {% if user.is_staff %}
        <a
          href="{% url 'admin:projects_devis_change' devis.pk %}"
          class="action-btn btn-primary"
          target="_blank"
        >
          <i class="fas fa-cog"></i>
          Administration
        </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const deleteForm = document.getElementById('delete-form');
    const deleteButton = document.getElementById('delete-button');
    const deleteText = document.getElementById('delete-text');
    const confirmReference = document.getElementById('confirm-reference');
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const deletionReason = document.getElementById('deletion-reason');
    const deletionComment = document.getElementById('deletion-comment');

    const devisReference = '{{ devis.reference|escapejs }}';
    const devisStatus = '{{ devis.status|escapejs }}';

    // Fonction de validation
    function validateForm() {
      const allChecked = Array.from(checkboxes).every((cb) => cb.checked);
      const referenceMatches = confirmReference && confirmReference.value.trim() === devisReference;
      const reasonSelected = deletionReason && deletionReason.value;
      const commentFilled = deletionComment && deletionComment.value.trim().length >= 10;

      if (allChecked && referenceMatches && reasonSelected && commentFilled) {
        deleteButton.disabled = false;
        deleteButton.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        deleteButton.disabled = true;
        deleteButton.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }

    // Event listeners
    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', validateForm);
    });

    if (confirmReference) {
      confirmReference.addEventListener('input', function () {
        validateForm();

        // Visual feedback for reference matching
        if (this.value.trim() === devisReference) {
          this.classList.remove('border-red-300');
          this.classList.add('border-green-300', 'bg-green-50');
        } else if (this.value.trim().length > 0) {
          this.classList.remove('border-green-300', 'bg-green-50');
          this.classList.add('border-red-300');
        } else {
          this.classList.remove('border-red-300', 'border-green-300', 'bg-green-50');
        }
      });
    }

    if (deletionReason) {
      deletionReason.addEventListener('change', validateForm);
    }

    if (deletionComment) {
      deletionComment.addEventListener('input', function () {
        validateForm();

        // Character counter
        const minLength = 10;
        const currentLength = this.value.trim().length;

        // Remove existing counter
        const existingCounter = this.parentNode.querySelector('.char-counter');
        if (existingCounter) {
          existingCounter.remove();
        }

        // Add counter
        const counter = document.createElement('div');
        counter.className = `char-counter text-xs mt-1 ${
          currentLength >= minLength ? 'text-green-600' : 'text-red-600'
        }`;
        counter.textContent = `${currentLength}/${minLength} caract√®res minimum`;
        this.parentNode.appendChild(counter);
      });
    }

    // Archive instead function
    window.archiveInstead = function () {
      if (confirm('Archiver ce devis plut√¥t que le supprimer ? (Recommand√©)')) {
        window.location.href = `{% url 'projects:devis_archive' pk=devis.pk %}`;
      }
    };

    // Form submission with countdown (plus long pour devis critiques)
    if (deleteForm) {
      deleteForm.addEventListener('submit', function (e) {
        e.preventDefault();

        let countdown = devisStatus === 'accepte' ? 10 : 5; // Plus de temps pour devis accept√©s
        deleteButton.disabled = true;

        const countdownInterval = setInterval(() => {
          deleteText.textContent = `Suppression dans ${countdown}s...`;
          deleteButton.classList.add('animate-pulse-danger');
          countdown--;

          if (countdown < 0) {
            clearInterval(countdownInterval);
            deleteText.textContent = 'Suppression en cours...';
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Suppression...';

            // Submit the form
            this.submit();
          }
        }, 1000);
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
      // Escape pour annuler
      if (e.key === 'Escape') {
        window.location.href = "{% url 'projects:devis_detail' pk=devis.pk %}";
      }

      // Emp√™cher Ctrl+S
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
      }
    });

    // Warn before leaving page
    window.addEventListener('beforeunload', function (e) {
      const formModified = Array.from(document.querySelectorAll('input, textarea, select')).some(
        (input) => {
          return input.value && input.value.trim().length > 0;
        }
      );

      if (formModified) {
        e.preventDefault();
        e.returnValue = '√ätes-vous s√ªr de vouloir quitter cette page ?';
      }
    });

    // Auto-focus and initial validation
    setTimeout(() => {
      const firstCheckbox = document.getElementById('confirm-understand');
      if (firstCheckbox) {
        firstCheckbox.focus();
      }
      validateForm();
    }, 500);

    // Show warning for critical devis
    if (devisStatus === 'accepte') {
      setTimeout(() => {
        const toast = document.createElement('div');
        toast.className =
          'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
        toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <i class="fas fa-exclamation-triangle text-xl mt-1"></i>
                    <div>
                        <h4 class="font-medium mb-1">‚ö†Ô∏è ATTENTION CRITIQUE</h4>
                        <p class="text-sm">Vous tentez de supprimer un devis accept√©. Assurez-vous d'avoir l'autorisation n√©cessaire.</p>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-sm underline mt-2">
                            Fermer
                        </button>
                    </div>
                </div>
            `;
        document.body.appendChild(toast);

        // Auto-remove after 15 seconds
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 15000);
      }, 1000);
    }
  });
</script>
{% endblock %}
