{% extends 'base_dashboard.html' %}
{% load static tailwind_tags %} 
{% block title %}Modifier {{ devis.reference }} - LOPES PEINTURE{% endblock %} 
{% block extra_css %}
{% tailwind_css %}
{% endblock %} 
{% block content %}
<div class="p-6 max-w-7xl mx-auto">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-2">
          <a
            href="{% url 'projects:devis_detail' pk=devis.pk %}"
            class="text-gray-600 hover:text-blue-600 transition-colors duration-200"
            title="Retour au devis"
          >
            <i class="fas fa-arrow-left text-lg"></i>
          </a>
          <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
            <i class="fas fa-edit text-blue-600"></i>
            Modifier le Devis
          </h1>
        </div>

        <div class="flex items-center gap-4 text-sm text-gray-600">
          <span class="font-mono">{{ devis.reference }}</span>
          <span
            class="status-indicator {% if devis.status == 'brouillon' %}bg-gray-100 text-gray-800 {% elif devis.status == 'envoye' %}bg-blue-100 text-blue-800 {% elif devis.status == 'accepte' %}bg-green-100 text-green-800 {% elif devis.status == 'refuse' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
          >
            {{ devis.get_status_display }}
          </span>
          {% if devis.version > 1 %}
          <span class="version-badge">
            <i class="fas fa-code-branch mr-1"></i>
            Version {{ devis.version }}
          </span>
          {% endif %}
        </div>
      </div>

      <!-- Actions rapides -->
      <div class="flex gap-3">
        <button type="button" onclick="showHistory()" class="action-btn btn-secondary">
          <i class="fas fa-history"></i>
          Historique
        </button>

        <button
          type="button"
          onclick="compareVersions()"
          class="action-btn btn-warning"
          {%
          if
          devis.version
          <="1"
          %}disabled{%
          endif
          %}
        >
          <i class="fas fa-exchange-alt"></i>
          Comparer
        </button>

        <button type="button" onclick="previewDevis()" class="action-btn btn-warning">
          <i class="fas fa-eye"></i>
          Aperçu
        </button>
      </div>
    </div>
  </div>

  <!-- Alertes et avertissements -->
  {% if devis.status != 'brouillon' %}
  <div class="warning-banner warning">
    <div class="flex items-start">
      <i class="fas fa-exclamation-triangle text-orange-600 mt-1 mr-3"></i>
      <div>
        <h3 class="font-medium mb-1">Attention</h3>
        <p class="text-sm">
          Ce devis a le statut "{{ devis.get_status_display }}". {% if devis.status == 'envoye' %}
          Toute modification créera une nouvelle version qui devra être renvoyée au client. {% elif
          devis.status == 'accepte' %} Attention: ce devis a été accepté par le client. Une
          modification pourrait affecter le contrat. {% elif devis.status == 'refuse' %} Ce devis a
          été refusé. Vous pouvez le modifier pour en créer une nouvelle version. {% endif %}
        </p>
      </div>
    </div>
  </div>
  {% endif %} {% if devis.is_expired %}
  <div class="warning-banner danger">
    <div class="flex items-start">
      <i class="fas fa-calendar-times text-red-600 mt-1 mr-3"></i>
      <div>
        <h3 class="font-medium mb-1">Devis expiré</h3>
        <p class="text-sm">
          Ce devis a expiré le {{ devis.date_expiry|date:"d/m/Y" }}. Considérez mettre à jour la
          date de validité.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Informations du projet associé -->
  <div class="bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg p-4 mb-8">
    <div class="flex items-start justify-between">
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
          <i class="fas fa-paint-brush text-blue-600 mr-2"></i>
          {{ devis.project.title }}
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div>
            <span class="text-gray-600">Client:</span>
            <span class="font-medium ml-2"
              >{{ devis.project.user.get_full_name|default:devis.project.user.username }}</span
            >
          </div>
          <div>
            <span class="text-gray-600">Surface:</span>
            <span class="font-medium ml-2">{{ devis.project.surface_totale }}m²</span>
          </div>
          <div>
            <span class="text-gray-600">Créé le:</span>
            <span class="font-medium ml-2">{{ devis.created_at|date:"d/m/Y à H:i" }}</span>
          </div>
        </div>
      </div>
      <a
        href="{% url 'projects:detail' pk=devis.project.pk %}"
        class="text-blue-600 hover:text-blue-700 text-sm"
        target="_blank"
      >
        <i class="fas fa-external-link-alt mr-1"></i>
        Voir le projet
      </a>
    </div>
  </div>

  <!-- Layout principal -->
  <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
    <!-- Formulaire principal -->
    <div class="xl:col-span-3">
      <form method="post" id="devis-form" class="space-y-8">
        {% csrf_token %}

        <!-- ================================ -->
        <!-- SECTION 1: INFORMATIONS GÉNÉRALES -->
        <!-- ================================ -->
        <div class="form-section">
          <div class="form-section-header">
            <i class="fas fa-info-circle text-blue-600 text-xl"></i>
            <h2 class="text-xl font-semibold text-gray-900">Informations Générales</h2>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Titre -->
            <div class="form-group lg:col-span-2">
              <label for="{{ form.title.id_for_label }}" class="form-label">
                Titre du devis <span class="text-red-500">*</span>
              </label>
              {{ form.title }} {% if form.title.errors %}
              <div class="form-error">{{ form.title.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Description -->
            <div class="form-group lg:col-span-2">
              <label for="{{ form.description.id_for_label }}" class="form-label">
                Description
              </label>
              {{ form.description }} {% if form.description.errors %}
              <div class="form-error">{{ form.description.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Date limite -->
            <div class="form-group">
              <label for="{{ form.date_expiry.id_for_label }}" class="form-label">
                Date limite de validité
              </label>
              {{ form.date_expiry }} {% if form.date_expiry.errors %}
              <div class="form-error">{{ form.date_expiry.errors.0 }}</div>
              {% endif %} {% if devis.is_expired %}
              <div class="text-xs text-red-600 mt-1">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Actuellement expiré
              </div>
              {% endif %}
            </div>

            <!-- Référence (lecture seule) -->
            <div class="form-group">
              <label class="form-label">Référence</label>
              <div
                class="px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 font-mono"
              >
                {{ devis.reference }}
              </div>
              <p class="text-xs text-gray-500 mt-1">La référence ne peut pas être modifiée</p>
            </div>
          </div>
        </div>

        <!-- ================================ -->
        <!-- SECTION 2: PRESTATIONS -->
        <!-- ================================ -->
        <div class="form-section">
          <div class="form-section-header">
            <i class="fas fa-list-ul text-blue-600 text-xl"></i>
            <h2 class="text-xl font-semibold text-gray-900">Prestations</h2>
            <div class="ml-auto">
              <span class="auto-calc-badge">
                <i class="fas fa-calculator mr-1"></i>
                Calcul automatique
              </span>
            </div>
          </div>

          <!-- Items du devis -->
          <div id="items-container">
            <div class="mb-4">
              <div
                class="grid grid-cols-12 gap-3 mb-2 text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                <div class="col-span-4">Description</div>
                <div class="col-span-2 text-center">Quantité</div>
                <div class="col-span-2 text-center">Unité</div>
                <div class="col-span-2 text-right">Prix Unit. HT</div>
                <div class="col-span-1 text-right">Total HT</div>
                <div class="col-span-1 text-center">Actions</div>
              </div>
            </div>

            <!-- Items existants (via formset) -->
            {{ items_formset.management_form }}
            <div id="items-list">
              {% for form in items_formset %}
              <div class="item-row" data-item-index="{{ forloop.counter0 }}">
                <!-- Description -->
                <div class="col-span-4">
                  {{ form.description }} {% if form.description.errors %}
                  <div class="form-error">{{ form.description.errors.0 }}</div>
                  {% endif %}
                  <!-- Détails optionnels -->
                  <div class="mt-2">
                    {{ form.details }} {% if form.details.errors %}
                    <div class="form-error">{{ form.details.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <!-- Quantité -->
                <div class="col-span-2">
                  {{ form.quantity }} {% if form.quantity.errors %}
                  <div class="form-error">{{ form.quantity.errors.0 }}</div>
                  {% endif %}
                </div>

                <!-- Unité -->
                <div class="col-span-2">
                  {{ form.unit }} {% if form.unit.errors %}
                  <div class="form-error">{{ form.unit.errors.0 }}</div>
                  {% endif %}
                </div>

                <!-- Prix unitaire -->
                <div class="col-span-2">
                  {{ form.unit_price }} {% if form.unit_price.errors %}
                  <div class="form-error">{{ form.unit_price.errors.0 }}</div>
                  {% endif %}
                </div>

                <!-- Total calculé -->
                <div class="col-span-1">
                  <div class="text-right font-mono text-sm text-gray-600 py-2 px-3">
                    <span class="item-total"
                      >{{ form.instance.total|floatformat:2|default:"0.00" }}€</span
                    >
                  </div>
                </div>

                <!-- Actions -->
                <div class="col-span-1 flex justify-center">
                  <button
                    type="button"
                    onclick="removeItem(this)"
                    class="item-remove-btn"
                    title="Supprimer cette ligne"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>

                <!-- Hidden fields -->
                {{ form.DELETE }} {% if form.id %}{{ form.id }}{% endif %}
              </div>
              {% endfor %}
            </div>

            <!-- Bouton ajouter item -->
            <div class="flex justify-start mb-6">
              <button type="button" onclick="addItem()" class="add-item-btn">
                <i class="fas fa-plus"></i>
                Ajouter une prestation
              </button>
            </div>
          </div>

          <!-- Totaux -->
          <div class="border-t border-gray-300 pt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Remise et TVA -->
              <div class="space-y-4">
                <div class="form-group">
                  <label for="{{ form.discount_percentage.id_for_label }}" class="form-label">
                    Remise (%)
                  </label>
                  {{ form.discount_percentage }} {% if form.discount_percentage.errors %}
                  <div class="form-error">{{ form.discount_percentage.errors.0 }}</div>
                  {% endif %}
                </div>

                <div class="form-group">
                  <label for="{{ form.tax_rate.id_for_label }}" class="form-label">
                    Taux TVA (%)
                  </label>
                  {{ form.tax_rate }} {% if form.tax_rate.errors %}
                  <div class="form-error">{{ form.tax_rate.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Résumé des totaux -->
              <div class="calculator-card">
                <h4 class="font-medium text-gray-900 mb-4">Récapitulatif</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Sous-total HT:</span>
                    <span class="font-mono" id="subtotal-display"
                      >{{ devis.subtotal|floatformat:2 }}€</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Remise:</span>
                    <span class="font-mono text-green-600" id="discount-display"
                      >{{ devis.discount_amount|floatformat:2 }}€</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Total HT:</span>
                    <span class="font-mono" id="total-ht-display"
                      >{{ devis.total_ht|floatformat:2 }}€</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">TVA:</span>
                    <span class="font-mono" id="tax-display"
                      >{{ devis.tax_amount|floatformat:2 }}€</span
                    >
                  </div>
                  <div class="flex justify-between pt-2 border-t border-blue-300 font-medium">
                    <span class="text-blue-900">TOTAL TTC:</span>
                    <span class="total-display" id="total-ttc-display"
                      >{{ devis.total|floatformat:2 }}€</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ================================ -->
        <!-- SECTION 3: CONDITIONS ET NOTES -->
        <!-- ================================ -->
        <div class="form-section">
          <div class="form-section-header">
            <i class="fas fa-file-contract text-blue-600 text-xl"></i>
            <h2 class="text-xl font-semibold text-gray-900">Conditions et Notes</h2>
          </div>

          <div class="grid grid-cols-1 gap-6">
            <!-- Conditions -->
            <div class="form-group">
              <label for="{{ form.terms_conditions.id_for_label }}" class="form-label">
                Conditions générales
              </label>
              {{ form.terms_conditions }} {% if form.terms_conditions.errors %}
              <div class="form-error">{{ form.terms_conditions.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Notes -->
            <div class="form-group">
              <label for="{{ form.notes.id_for_label }}" class="form-label">
                Notes internes
                <span class="text-xs text-orange-600 ml-2">(Non visible par le client)</span>
              </label>
              {{ form.notes }} {% if form.notes.errors %}
              <div class="form-error">{{ form.notes.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-section">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <!-- Boutons secondaires -->
            <div class="flex gap-3">
              <a
                href="{% url 'projects:devis_detail' pk=devis.pk %}"
                class="action-btn btn-secondary"
              >
                <i class="fas fa-times"></i>
                Annuler
              </a>

              <button type="button" onclick="saveDraft()" class="action-btn btn-warning">
                <i class="fas fa-save"></i>
                Sauvegarder brouillon
              </button>
            </div>

            <!-- Boutons principaux -->
            <div class="flex gap-3">
              {% if devis.status == 'brouillon' %}
              <button
                type="submit"
                name="save_and_send"
                class="action-btn btn-success"
                onclick="return confirm('Sauvegarder et envoyer ce devis au client ?')"
              >
                <i class="fas fa-paper-plane"></i>
                Sauvegarder et envoyer
              </button>
              {% endif %} {% if devis.status in 'envoye,refuse' %}
              <button
                type="submit"
                name="create_version"
                class="action-btn btn-primary"
                onclick="return confirm('Créer une nouvelle version de ce devis ?')"
              >
                <i class="fas fa-code-branch"></i>
                Créer nouvelle version
              </button>
              {% endif %}

              <button type="submit" class="action-btn btn-primary" id="save-button">
                <i class="fas fa-save"></i>
                Sauvegarder les modifications
              </button>
            </div>
          </div>
        </div>

        <!-- Erreurs globales -->
        {% if form.non_field_errors or items_formset.non_form_errors %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
            <h3 class="text-sm font-medium text-red-800">Erreurs de validation</h3>
          </div>
          <div class="mt-2 text-sm text-red-700">
            {{ form.non_field_errors }} {{ items_formset.non_form_errors }}
          </div>
        </div>
        {% endif %}
      </form>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Informations du devis -->
      <div class="sidebar-card">
        <div class="flex items-center gap-3 mb-4">
          <i class="fas fa-info-circle text-blue-600 text-lg"></i>
          <h3 class="text-lg font-semibold text-gray-900">Informations</h3>
        </div>

        <div class="space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Référence:</span>
            <span class="font-mono">{{ devis.reference }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Version:</span>
            <span class="font-medium">{{ devis.version }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Statut:</span>
            <span
              class="status-indicator {% if devis.status == 'brouillon' %}bg-gray-100 text-gray-800 {% elif devis.status == 'envoye' %}bg-blue-100 text-blue-800 {% elif devis.status == 'accepte' %}bg-green-100 text-green-800 {% elif devis.status == 'refuse' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
            >
              {{ devis.get_status_display }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Créé le:</span>
            <span>{{ devis.created_at|date:"d/m/Y" }}</span>
          </div>
          {% if devis.sent_at %}
          <div class="flex justify-between">
            <span class="text-gray-600">Envoyé le:</span>
            <span>{{ devis.sent_at|date:"d/m/Y" }}</span>
          </div>
          {% endif %} {% if devis.date_expiry %}
          <div class="flex justify-between">
            <span class="text-gray-600">Expire le:</span>
            <span class="{% if devis.is_expired %}text-red-600 font-medium{% endif %}">
              {{ devis.date_expiry|date:"d/m/Y" }}
            </span>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Actions rapides -->
      <div class="sidebar-card">
        <div class="flex items-center gap-3 mb-4">
          <i class="fas fa-bolt text-blue-600 text-lg"></i>
          <h3 class="text-lg font-semibold text-gray-900">Actions Rapides</h3>
        </div>

        <div class="space-y-3">
          <button
            type="button"
            onclick="duplicateDevis()"
            class="w-full action-btn btn-secondary justify-center"
          >
            <i class="fas fa-copy"></i>
            Dupliquer le devis
          </button>

          {% if devis.status == 'brouillon' %}
          <form method="post" action="{% url 'projects:devis_send' pk=devis.pk %}" class="w-full">
            {% csrf_token %}
            <button
              type="submit"
              class="w-full action-btn btn-success justify-center"
              onclick="return confirm('Envoyer ce devis au client ?')"
            >
              <i class="fas fa-paper-plane"></i>
              Envoyer au client
            </button>
          </form>
          {% endif %}

          <a
            href="{% url 'projects:devis_pdf' pk=devis.pk %}"
            class="w-full action-btn btn-warning justify-center"
            target="_blank"
          >
            <i class="fas fa-file-pdf"></i>
            Télécharger PDF
          </a>

          <a
            href="{% url 'projects:devis_list' %}"
            class="w-full action-btn btn-secondary justify-center"
          >
            <i class="fas fa-list"></i>
            Tous les devis
          </a>
        </div>
      </div>

      <!-- Historique des modifications -->
      <div class="sidebar-card">
        <div class="flex items-center gap-3 mb-4">
          <i class="fas fa-history text-blue-600 text-lg"></i>
          <h3 class="text-lg font-semibold text-gray-900">Historique Récent</h3>
        </div>

        <div class="space-y-3 max-h-64 overflow-y-auto">
          {% for log in devis.history.all|slice:":5" %}
          <div class="history-item">
            <div class="w-2 h-2 rounded-full bg-blue-500 mt-2 flex-shrink-0"></div>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900">{{ log.get_action_display }}</p>
              <p class="text-xs text-gray-600">
                {{ log.user.get_full_name|default:log.user.username }}
              </p>
              <div class="text-xs text-gray-500">{{ log.created_at|timesince }}</div>
            </div>
          </div>
          {% empty %}
          <div class="text-center py-4 text-gray-500">
            <i class="fas fa-history text-xl mb-2"></i>
            <p class="text-sm">Aucun historique</p>
          </div>
          {% endfor %}
        </div>

        {% if devis.history.count > 5 %}
        <div class="mt-4 pt-4 border-t border-gray-200">
          <button onclick="showFullHistory()" class="text-sm text-blue-600 hover:text-blue-700">
            Voir l'historique complet ({{ devis.history.count }} éléments)
          </button>
        </div>
        {% endif %}
      </div>

      <!-- Aide contextuelle -->
      <div class="sidebar-card">
        <div class="flex items-center gap-3 mb-4">
          <i class="fas fa-question-circle text-blue-600 text-lg"></i>
          <h3 class="text-lg font-semibold text-gray-900">Aide</h3>
        </div>

        <div class="space-y-3 text-sm text-gray-600">
          {% if devis.status == 'brouillon' %}
          <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="font-medium text-blue-800 mb-1">💡 Conseil</p>
            <p class="text-blue-700">
              Vous pouvez modifier librement ce devis car il est encore en brouillon.
            </p>
          </div>
          {% elif devis.status == 'envoye' %}
          <div class="p-3 bg-orange-50 border border-orange-200 rounded-lg">
            <p class="font-medium text-orange-800 mb-1">⚠️ Attention</p>
            <p class="text-orange-700">
              Ce devis a été envoyé. Toute modification créera une nouvelle version.
            </p>
          </div>
          {% endif %}

          <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
            <p class="font-medium text-green-800 mb-1">✅ Rappel</p>
            <p class="text-green-700">Les modifications sont automatiquement sauvegardées.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- History Modal -->
<div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Historique Complet</h3>
          <button type="button" onclick="closeHistory()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div id="history-content" class="p-6">
        <!-- Contenu sera chargé via JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Comparison Modal -->
<div id="comparison-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-6xl w-full max-h-screen overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Comparaison des Versions</h3>
          <button
            type="button"
            onclick="closeComparison()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div id="comparison-content" class="p-6">
        <!-- Contenu sera chargé via JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Aperçu du Devis</h3>
          <button type="button" onclick="closePreview()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div id="preview-content" class="p-6">
        <!-- Contenu du preview sera généré par JavaScript -->
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      let itemIndex = {{ items_formset.total_form_count }};

      // Calculer les totaux
      function calculateTotals() {
          let subtotal = 0;

          document.querySelectorAll('.item-row').forEach(row => {
              const quantity = parseFloat(row.querySelector('input[name$="-quantity"]').value) || 0;
              const unitPrice = parseFloat(row.querySelector('input[name$="-unit_price"]').value) || 0;
              const total = quantity * unitPrice;

              row.querySelector('.item-total').textContent = total.toFixed(2) + '€';
              subtotal += total;
          });

          const discountPercentage = parseFloat(document.getElementById('{{ form.discount_percentage.id_for_label }}').value) || 0;
          const taxRate = parseFloat(document.getElementById('{{ form.tax_rate.id_for_label }}').value) || 20;

          const discountAmount = subtotal * (discountPercentage / 100);
          const totalHT = subtotal - discountAmount;
          const taxAmount = totalHT * (taxRate / 100);
          const totalTTC = totalHT + taxAmount;

          document.getElementById('subtotal-display').textContent = subtotal.toFixed(2) + '€';
          document.getElementById('discount-display').textContent = discountAmount.toFixed(2) + '€';
          document.getElementById('total-ht-display').textContent = totalHT.toFixed(2) + '€';
          document.getElementById('tax-display').textContent = taxAmount.toFixed(2) + '€';
          document.getElementById('total-ttc-display').textContent = totalTTC.toFixed(2) + '€';
      }

      // Ajouter un item (similaire ao template create)
      window.addItem = function() {
          const container = document.getElementById('items-list');
          const newRow = document.createElement('div');
          newRow.className = 'item-row';
          newRow.setAttribute('data-item-index', itemIndex);

          newRow.innerHTML = `
              <div class="col-span-4">
                  <input type="text" name="items-${itemIndex}-description" class="form-input" placeholder="Description de la prestation">
                  <input type="text" name="items-${itemIndex}-details" class="form-input mt-2" placeholder="Détails optionnels">
              </div>
              <div class="col-span-2">
                  <input type="number" name="items-${itemIndex}-quantity" class="form-input" placeholder="Qté" step="0.01" min="0">
              </div>
              <div class="col-span-2">
                  <select name="items-${itemIndex}-unit" class="form-select">
                      <option value="m²">m²</option>
                      <option value="ml">ml</option>
                      <option value="pièce">pièce</option>
                      <option value="forfait">forfait</option>
                      <option value="heure">heure</option>
                      <option value="jour">jour</option>
                  </select>
              </div>
              <div class="col-span-2">
                  <input type="number" name="items-${itemIndex}-unit_price" class="form-input" placeholder="Prix" step="0.01" min="0">
              </div>
              <div class="col-span-1">
                  <div class="text-right font-mono text-sm text-gray-600 py-2 px-3">
                      <span class="item-total">0.00€</span>
                  </div>
              </div>
              <div class="col-span-1 flex justify-center">
                  <button type="button" onclick="removeItem(this)" class="item-remove-btn" title="Supprimer cette ligne">
                      <i class="fas fa-trash"></i>
                  </button>
              </div>
          `;

          container.appendChild(newRow);

          // Update management form
          const totalForms = document.getElementById('id_items-TOTAL_FORMS');
          totalForms.value = parseInt(totalForms.value) + 1;

          itemIndex++;

          // Add event listeners
          const inputs = newRow.querySelectorAll('input[type="number"]');
          inputs.forEach(input => {
              input.addEventListener('input', calculateTotals);
          });
      };

      // Supprimer un item
      window.removeItem = function(button) {
          const row = button.closest('.item-row');
          const deleteInput = row.querySelector('input[name$="-DELETE"]');

          if (deleteInput) {
              deleteInput.checked = true;
              row.style.display = 'none';
          } else {
              row.remove();
              const totalForms = document.getElementById('id_items-TOTAL_FORMS');
              totalForms.value = parseInt(totalForms.value) - 1;
          }

          calculateTotals();
      };

      // Show history
      window.showHistory = function() {
          const modal = document.getElementById('history-modal');
          const content = document.getElementById('history-content');

          // Load history via AJAX
          fetch(`{% url 'projects:devis_history' pk=devis.pk %}`)
              .then(response => response.text())
              .then(html => {
                  content.innerHTML = html;
                  modal.classList.remove('hidden');
              });
      };

      // Close history
      window.closeHistory = function() {
          document.getElementById('history-modal').classList.add('hidden');
      };

      // Compare versions
      window.compareVersions = function() {
          const modal = document.getElementById('comparison-modal');
          const content = document.getElementById('comparison-content');

          // Load comparison via AJAX
          fetch(`{% url 'projects:devis_compare' pk=devis.pk %}`)
              .then(response => response.text())
              .then(html => {
                  content.innerHTML = html;
                  modal.classList.remove('hidden');
              });
      };

      // Close comparison
      window.closeComparison = function() {
          document.getElementById('comparison-modal').classList.add('hidden');
      };

      // Preview devis (similar to create template)
      window.previewDevis = function() {
          const modal = document.getElementById('preview-modal');
          const content = document.getElementById('preview-content');

          const title = document.getElementById('{{ form.title.id_for_label }}').value;

          content.innerHTML = `
              <div class="text-center mb-6">
                  <h2 class="text-2xl font-bold text-gray-900">${title || '{{ devis.title }}'}</h2>
                  <p class="text-gray-600">Référence: {{ devis.reference }}</p>
              </div>

              <div class="space-y-6">
                  <div>
                      <h3 class="text-lg font-semibold mb-3">Prestations</h3>
                      <table class="w-full border-collapse border border-gray-300">
                          <thead>
                              <tr class="bg-gray-50">
                                  <th class="border border-gray-300 p-2 text-left">Description</th>
                                  <th class="border border-gray-300 p-2 text-center">Qté</th>
                                  <th class="border border-gray-300 p-2 text-center">Unité</th>
                                  <th class="border border-gray-300 p-2 text-right">Prix Unit.</th>
                                  <th class="border border-gray-300 p-2 text-right">Total</th>
                              </tr>
                          </thead>
                          <tbody id="preview-items">
                          </tbody>
                      </table>
                  </div>

                  <div class="text-right">
                      <div class="inline-block space-y-2">
                          <div class="flex justify-between gap-8">
                              <span>Total TTC:</span>
                              <span class="font-bold text-xl" id="preview-total">${document.getElementById('total-ttc-display').textContent}</span>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          // Add items to preview
          const itemsTable = document.getElementById('preview-items');
          document.querySelectorAll('.item-row:not([style*="display: none"])').forEach(row => {
              const description = row.querySelector('input[name$="-description"]').value;
              const quantity = row.querySelector('input[name$="-quantity"]').value;
              const unit = row.querySelector('select[name$="-unit"]').value;
              const price = row.querySelector('input[name$="-unit_price"]').value;
              const total = (parseFloat(quantity) || 0) * (parseFloat(price) || 0);

              if (description) {
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                      <td class="border border-gray-300 p-2">${description}</td>
                      <td class="border border-gray-300 p-2 text-center">${quantity}</td>
                      <td class="border border-gray-300 p-2 text-center">${unit}</td>
                      <td class="border border-gray-300 p-2 text-right">${parseFloat(price).toFixed(2)}€</td>
                      <td class="border border-gray-300 p-2 text-right">${total.toFixed(2)}€</td>
                  `;
                  itemsTable.appendChild(tr);
              }
          });

          modal.classList.remove('hidden');
      };

      // Close preview
      window.closePreview = function() {
          document.getElementById('preview-modal').classList.add('hidden');
      };

      // Duplicate devis
      window.duplicateDevis = function() {
          if (confirm('Créer une copie de ce devis ?')) {
              window.location.href = `{% url 'projects:devis_duplicate' pk=devis.pk %}`;
          }
      };

      // Save draft
      window.saveDraft = function() {
          const form = document.getElementById('devis-form');
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = 'save_draft';
          hiddenInput.value = '1';
          form.appendChild(hiddenInput);
          form.submit();
      };

      // Auto-save functionality
      let autoSaveTimeout;
      function startAutoSave() {
          document.querySelectorAll('input, textarea, select').forEach(input => {
              input.addEventListener('input', () => {
                  clearTimeout(autoSaveTimeout);
                  autoSaveTimeout = setTimeout(() => {
                      console.log('Auto-saving...');
                      // Implement auto-save logic here
                  }, 5000);
              });
          });
      }

      // Event listeners
      document.addEventListener('input', calculateTotals);
      document.addEventListener('change', calculateTotals);

      // Form validation
      document.getElementById('devis-form').addEventListener('submit', function(e) {
          // Loading state
          const submitButtons = document.querySelectorAll('button[type="submit"]');
          submitButtons.forEach(btn => {
              btn.disabled = true;
              const originalText = btn.innerHTML;
              btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sauvegarde...';

              // Restore after 5 seconds in case of error
              setTimeout(() => {
                  btn.disabled = false;
                  btn.innerHTML = originalText;
              }, 5000);
          });
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
          // Ctrl + S pour sauvegarder
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              document.getElementById('save-button').click();
          }

          // Ctrl + Enter pour aperçu
          if (e.ctrlKey && e.key === 'Enter') {
              e.preventDefault();
              previewDevis();
          }
      });

      // Initialize
      calculateTotals();
      startAutoSave();

      // Warn about unsaved changes
      let hasUnsavedChanges = false;
      document.querySelectorAll('input, textarea, select').forEach(input => {
          input.addEventListener('change', () => {
              hasUnsavedChanges = true;
          });
      });

      window.addEventListener('beforeunload', function(e) {
          if (hasUnsavedChanges) {
              e.preventDefault();
              e.returnValue = '';
          }
      });

      // Reset flag on form submit
      document.getElementById('devis-form').addEventListener('submit', () => {
          hasUnsavedChanges = false;
      });
  });
</script>
{% endblock %}
