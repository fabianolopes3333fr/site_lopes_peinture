{% extends 'base_dashboard.html' %} 
{% load static tailwind_tags %} 
{% block title %}{{ project.title }} - LOPES PEINTURE{% endblock %} 

{% block extra_css %}
{% tailwind_css %}
<style>
/* Manter os estilos existentes... */
.progress-ring {
  transform: rotate(-90deg);
  transition: stroke-dashoffset 1s ease-in-out;
}

.timeline-item {
  position: relative;
  padding-left: 2rem;
}

.timeline-item:not(:last-child)::before {
  content: '';
  position: absolute;
  left: 0.5rem;
  top: 1.5rem;
  bottom: -1rem;
  width: 2px;
  background-color: #e5e7eb;
}

.timeline-dot {
  position: absolute;
  left: 0;
  top: 0.25rem;
  width: 1rem;
  height: 1rem;
  border-radius: 50%;
  border: 2px solid white;
  box-shadow: 0 0 0 1px #e5e7eb;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fadeIn 0.5s ease-out;
}
</style>
{% endblock %} 

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
  <div class="p-6 max-w-7xl mx-auto">
    <!-- Header Principal -->
    <div class="mb-8">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2">
            <a
              href="{% url 'projects:projet_list' %}"
              class="text-gray-600 hover:text-blue-600 transition-colors duration-200"
              title="Retour à la liste"
            >
              <i class="fas fa-arrow-left text-lg"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">{{ project.title }}</h1>
          </div>

          <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600">
            <div class="flex items-center gap-2">
              <i class="fas fa-hashtag text-gray-400"></i>
              <span class="font-mono">{{ project.reference }}</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="fas fa-calendar text-gray-400"></i>
              <span>Créé le {{ project.created_at|date:"d/m/Y à H:i" }}</span>
            </div>
            {% if project.ville %}
            <div class="flex items-center gap-2">
              <i class="fas fa-map-marker-alt text-gray-400"></i>
              <span>{{ project.ville }}{% if project.code_postal %}, {{ project.code_postal }}{% endif %}</span>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Actions principales -->
        <div class="flex flex-wrap gap-3">
          {% if can_edit %}
          <a href="{% url 'projects:projet_update' pk=project.pk %}" 
             class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
            <i class="fas fa-edit mr-2"></i>
            Modifier
          </a>
          {% endif %} 
          
          {% if can_request_devis %}
          <form
            method="post"
            action="{% url 'projects:projet_detail' pk=project.pk %}"
            class="inline"
          >
            {% csrf_token %}
            <input type="hidden" name="action" value="request_devis">
            <button
              type="submit"
              class="inline-flex items-center px-4 py-2 border border-orange-300 rounded-md shadow-sm text-sm font-medium text-orange-700 bg-orange-50 hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors duration-200"
              onclick="return confirm('Demander un devis pour ce projet ?')"
            >
              <i class="fas fa-file-invoice-dollar mr-2"></i>
              Demander un devis
            </button>
          </form>
          {% endif %} 
          
          {% if is_staff and project.status == 'devis_demande' %}
          <a
            href="{% url 'projects:projet_create_devis' pk=project.pk %}"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200"
          >
            <i class="fas fa-plus mr-2"></i>
            Créer devis
          </a>
          {% endif %} 
          
          {% if project.status == 'brouillon' and can_edit %}
          <a
            href="{% url 'projects:projet_delete' pk=project.pk %}"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200"
            onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce projet ?')"
          >
            <i class="fas fa-trash mr-2"></i>
            Supprimer
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Layout principal -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
      <!-- Colonne principale -->
      <div class="xl:col-span-2 space-y-8">
        <!-- Informations générales -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-info-circle text-blue-600 text-xl"></i>
              <h2 class="text-xl font-semibold text-gray-900">Informations Générales</h2>
            </div>
          </div>
          <div class="p-6">
            {% if project.description %}
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-600 mb-2">Description</h3>
              <p class="text-gray-900 leading-relaxed">{{ project.description|linebreaks }}</p>
            </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="flex items-start gap-3">
                <i class="fas fa-paint-brush text-blue-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Type de projet</div>
                  <div class="text-base text-gray-900">{{ project.get_project_type_display|default:"Non spécifié" }}</div>
                </div>
              </div>

              <div class="flex items-start gap-3">
                <i class="fas fa-flag text-orange-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Priorité</div>
                  <div class="text-base text-gray-900">
                    <span
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if project.priority == 'urgente' %}bg-red-100 text-red-800 {% elif project.priority == 'elevee' %}bg-orange-100 text-orange-800 {% elif project.priority == 'normale' %}bg-blue-100 text-blue-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
                    >
                      {{ project.get_priority_display|default:"Non spécifiée" }}
                    </span>
                  </div>
                </div>
              </div>

              {% if project.surface_totale %}
              <div class="flex items-start gap-3">
                <i class="fas fa-ruler-combined text-green-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Surface totale</div>
                  <div class="text-base text-gray-900">{{ project.surface_totale }}m²</div>
                </div>
              </div>
              {% endif %}

              {% if project.nombre_pieces %}
              <div class="flex items-start gap-3">
                <i class="fas fa-home text-purple-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Nombre de pièces</div>
                  <div class="text-base text-gray-900">
                    {{ project.nombre_pieces }} pièce{{ project.nombre_pieces|pluralize }}
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Détails techniques -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-cogs text-blue-600 text-xl"></i>
              <h2 class="text-xl font-semibold text-gray-900">Détails Techniques</h2>
            </div>
          </div>
          <div class="p-6">
            <!-- Surfaces -->
            {% if project.surface_totale or project.surface_murs or project.surface_plafond %}
            <div class="mb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-ruler-combined text-gray-600"></i>
                Surfaces et Dimensions
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {% if project.surface_totale %}
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4 text-center">
                  <div class="text-2xl font-bold text-blue-900">{{ project.surface_totale }}m²</div>
                  <div class="text-sm text-blue-700">Surface totale</div>
                </div>
                {% endif %}
                
                {% if project.surface_murs %}
                <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4 text-center">
                  <div class="text-2xl font-bold text-green-900">{{ project.surface_murs }}m²</div>
                  <div class="text-sm text-green-700">Surface des murs</div>
                </div>
                {% endif %}
                
                {% if project.surface_plafond %}
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-4 text-center">
                  <div class="text-2xl font-bold text-purple-900">{{ project.surface_plafond }}m²</div>
                  <div class="text-sm text-purple-700">Surface du plafond</div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Types de pièces -->
            {% if project.types_pieces %}
            <div class="mb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-home text-gray-600"></i>
                Types de Pièces
              </h3>
              <div class="flex flex-wrap gap-2">
                {% for piece in project.types_pieces.split %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                  {{ piece|capfirst }}
                </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- État et finitions -->
            {% if project.etat_support or project.type_finition %}
            <div class="mb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-palette text-gray-600"></i>
                État et Finitions
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% if project.etat_support %}
                <div class="flex items-start gap-3">
                  <i class="fas fa-hammer text-orange-600 text-lg flex-shrink-0 mt-0.5"></i>
                  <div>
                    <div class="text-sm font-medium text-gray-600">État du support</div>
                    <div class="text-base text-gray-900">{{ project.get_etat_support_display|default:project.etat_support }}</div>
                  </div>
                </div>
                {% endif %}

                {% if project.type_finition %}
                <div class="flex items-start gap-3">
                  <i class="fas fa-brush text-purple-600 text-lg flex-shrink-0 mt-0.5"></i>
                  <div>
                    <div class="text-sm font-medium text-gray-600">Type de finition</div>
                    <div class="text-base text-gray-900">{{ project.get_type_finition_display|default:project.type_finition }}</div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Couleurs -->
            {% if project.couleur_murs or project.couleur_plafond or project.couleur_boiseries %}
            <div class="mb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-paint-brush text-gray-600"></i>
                Couleurs Souhaitées
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                {% if project.couleur_murs %}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="text-sm font-medium text-gray-600 mb-1">Murs</div>
                  <div class="text-sm text-gray-900">{{ project.couleur_murs }}</div>
                </div>
                {% endif %}
                
                {% if project.couleur_plafond %}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="text-sm font-medium text-gray-600 mb-1">Plafond</div>
                  <div class="text-sm text-gray-900">{{ project.couleur_plafond }}</div>
                </div>
                {% endif %}
                
                {% if project.couleur_boiseries %}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="text-sm font-medium text-gray-600 mb-1">Boiseries</div>
                  <div class="text-sm text-gray-900">{{ project.couleur_boiseries }}</div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Matériaux et contraintes -->
            {% if project.materiaux_specifiques or project.contraintes_horaires or project.preparation_necessaire %}
            <div class="mb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-gray-600"></i>
                Contraintes et Spécificités
              </h3>

              {% if project.materiaux_specifiques %}
              <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="text-sm font-medium text-blue-800 mb-2">Matériaux spécifiques</h4>
                <p class="text-sm text-blue-700">{{ project.materiaux_specifiques }}</p>
              </div>
              {% endif %} 
              
              {% if project.preparation_necessaire %}
              <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h4 class="text-sm font-medium text-green-800 mb-2">Préparation nécessaire</h4>
                <p class="text-sm text-green-700">{{ project.preparation_necessaire }}</p>
              </div>
              {% endif %}
              
              {% if project.contraintes_horaires %}
              <div class="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                <h4 class="text-sm font-medium text-orange-800 mb-2">Contraintes horaires</h4>
                <p class="text-sm text-orange-700">{{ project.contraintes_horaires }}</p>
              </div>
              {% endif %} 
              
              {% if project.acces_difficile %}
              <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <h4 class="text-sm font-medium text-red-800 mb-2 flex items-center gap-2">
                  <i class="fas fa-exclamation-circle"></i>
                  Accès difficile
                </h4>
                <p class="text-sm text-red-700">
                  Des contraintes d'accès ou difficultés particulières sont signalées.
                </p>
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Adresse et Contact -->
        {% if project.adresse_travaux or project.contact_nom %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-map-marker-alt text-blue-600 text-xl"></i>
              <h2 class="text-xl font-semibold text-gray-900">Adresse et Contact</h2>
            </div>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              {% if project.adresse_travaux %}
              <div class="flex items-start gap-3">
                <i class="fas fa-home text-green-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Adresse des travaux</div>
                  <div class="text-base text-gray-900">
                    {{ project.adresse_travaux }} 
                    {% if project.complement_adresse %}
                    <br /><span class="text-gray-600">{{ project.complement_adresse }}</span>
                    {% endif %}
                    {% if project.code_postal or project.ville %}
                    <br />
                    {% if project.code_postal %}{{ project.code_postal }} {% endif %}
                    {% if project.ville %}{{ project.ville }}{% endif %}
                    {% endif %}
                    {% if project.pays and project.pays != 'France' %} 
                    <br />{{ project.pays }} 
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endif %}

              {% if project.contact_nom or project.contact_telephone %}
              <div class="flex items-start gap-3">
                <i class="fas fa-user text-purple-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Contact sur site</div>
                  <div class="text-base text-gray-900">
                    {% if project.contact_nom %}
                    {{ project.contact_nom }}
                    {% endif %} 
                    {% if project.contact_telephone %}
                    <br /><a
                      href="tel:{{ project.contact_telephone }}"
                      class="text-blue-600 hover:underline"
                    >
                      {{ project.contact_telephone }}
                    </a>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Planning et Budget -->
        {% if project.date_debut_souhaitee or project.date_fin_souhaitee or project.budget_minimum or project.budget_maximum %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-calendar-alt text-blue-600 text-xl"></i>
              <h2 class="text-xl font-semibold text-gray-900">Planning et Budget</h2>
            </div>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              {% if project.date_debut_souhaitee %}
              <div class="flex items-start gap-3">
                <i class="fas fa-play text-green-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Date de début souhaitée</div>
                  <div class="text-base text-gray-900">{{ project.date_debut_souhaitee|date:"d/m/Y" }}</div>
                </div>
              </div>
              {% endif %} 
              
              {% if project.date_fin_souhaitee %}
              <div class="flex items-start gap-3">
                <i class="fas fa-stop text-red-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Date de fin souhaitée</div>
                  <div class="text-base text-gray-900">{{ project.date_fin_souhaitee|date:"d/m/Y" }}</div>
                </div>
              </div>
              {% endif %} 
              
              {% if project.budget_minimum or project.budget_maximum %}
              <div class="flex items-start gap-3 md:col-span-2">
                <i class="fas fa-euro-sign text-blue-600 text-lg flex-shrink-0 mt-0.5"></i>
                <div>
                  <div class="text-sm font-medium text-gray-600">Budget estimé</div>
                  <div class="text-base text-gray-900">
                    {% if project.budget_minimum and project.budget_maximum %} 
                    {{ project.budget_minimum|floatformat:0 }}€ - {{ project.budget_maximum|floatformat:0 }}€ 
                    {% elif project.budget_minimum %} 
                    À partir de {{ project.budget_minimum|floatformat:0 }}€ 
                    {% elif project.budget_maximum %} 
                    Jusqu'à {{ project.budget_maximum|floatformat:0 }}€ 
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Notes du client -->
        {% if project.notes_client %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-sticky-note text-blue-600 text-xl"></i>
              <h2 class="text-xl font-semibold text-gray-900">Notes du Client</h2>
            </div>
          </div>
          <div class="p-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <p class="text-gray-900 leading-relaxed">{{ project.notes_client|linebreaks }}</p>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Devis associés -->
        {% if devis_list %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i class="fas fa-file-invoice-dollar text-blue-600 text-xl"></i>
                <h2 class="text-xl font-semibold text-gray-900">Devis Associés</h2>
              </div>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ devis_list.count }}
              </span>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              {% for devis in devis_list %}
              <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <h3 class="font-medium text-gray-900">
                        <a
                          href="{% url 'projects:devis_detail' pk=devis.pk %}"
                          class="hover:text-blue-600 transition-colors duration-200"
                        >
                          {{ devis.reference }}
                        </a>
                      </h3>
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if devis.status == 'brouillon' %}bg-gray-100 text-gray-800 {% elif devis.status == 'envoye' %}bg-blue-100 text-blue-800 {% elif devis.status == 'vu' %}bg-yellow-100 text-yellow-800 {% elif devis.status == 'accepte' %}bg-green-100 text-green-800 {% elif devis.status == 'refuse' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
                      >
                        {{ devis.get_status_display }}
                      </span>
                    </div>

                    <div class="flex items-center gap-4 text-sm text-gray-600">
                      <span>{{ devis.title|truncatechars:50 }}</span>
                      <span>{{ devis.created_at|date:"d/m/Y" }}</span>
                      {% if devis.total %}
                      <span class="font-medium text-blue-600">{{ devis.total|floatformat:2 }}€</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <a
                      href="{% url 'projects:devis_detail' pk=devis.pk %}"
                      class="p-2 text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded transition-colors duration-200"
                      title="Voir le devis"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Status et Progress -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-chart-pie text-blue-600 text-xl"></i>
              <h3 class="text-lg font-semibold text-gray-900">État du Projet</h3>
            </div>
          </div>
          <div class="p-6 text-center">
            <!-- Progress Circle -->
            <div class="relative inline-flex items-center justify-center mb-4">
              <svg class="progress-ring w-24 h-24" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                <circle
                  cx="50"
                  cy="50"
                  r="40"
                  stroke="{% if project.status == 'termine' %}#10b981{% elif project.status == 'en_cours' %}#f59e0b{% else %}#ef4444{% endif %}"
                  stroke-width="8"
                  fill="none"
                  stroke-dasharray="251.2"
                  stroke-linecap="round"
                />
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-2xl font-bold text-gray-900">
                  {% if project.status == 'termine' %}100{% elif project.status == 'en_cours' %}70{% elif project.status == 'devis_accepte' %}50{% else %}25{% endif %}%
                </span>
              </div>
            </div>

            <!-- Status actual -->
            <div class="mb-4">
              <span
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {% if project.status == 'brouillon' %}bg-gray-100 text-gray-800 {% elif project.status == 'soumis' %}bg-blue-100 text-blue-800 {% elif project.status == 'en_examen' %}bg-yellow-100 text-yellow-800 {% elif project.status == 'devis_demande' %}bg-orange-100 text-orange-800 {% elif project.status == 'devis_envoye' %}bg-purple-100 text-purple-800 {% elif project.status == 'devis_accepte' %}bg-green-100 text-green-800 {% elif project.status == 'termine' %}bg-emerald-100 text-emerald-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
              >
                {{ project.get_status_display }}
              </span>
            </div>

            <!-- Form admin para mudança de status -->
            {% if is_staff %}
            <form
              method="post"
              action="{% url 'projects:projet_detail' pk=project.pk %}"
              class="mt-4"
            >
              {% csrf_token %}
              <input type="hidden" name="action" value="update_status">
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Changer le statut</label>
                  <select name="status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">-- Sélectionner --</option>
                    <option value="brouillon" {% if project.status == 'brouillon' %}selected{% endif %}>Brouillon</option>
                    <option value="soumis" {% if project.status == 'soumis' %}selected{% endif %}>Soumis</option>
                    <option value="en_examen" {% if project.status == 'en_examen' %}selected{% endif %}>En examen</option>
                    <option value="devis_demande" {% if project.status == 'devis_demande' %}selected{% endif %}>Devis demandé</option>
                    <option value="devis_envoye" {% if project.status == 'devis_envoye' %}selected{% endif %}>Devis envoyé</option>
                    <option value="devis_accepte" {% if project.status == 'devis_accepte' %}selected{% endif %}>Devis accepté</option>
                    <option value="en_cours" {% if project.status == 'en_cours' %}selected{% endif %}>En cours</option>
                    <option value="termine" {% if project.status == 'termine' %}selected{% endif %}>Terminé</option>
                  </select>
                </div>

                {% if project.notes_internes %}
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Notes internes</label>
                  <textarea name="notes_internes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Notes pour l'équipe...">{{ project.notes_internes }}</textarea>
                </div>
                {% endif %}

                <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                  <i class="fas fa-save mr-2"></i>
                  Mettre à jour
                </button>
              </div>
            </form>
            {% endif %}
          </div>
        </div>

        <!-- Informações rápidas -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-info text-blue-600 text-xl"></i>
              <h3 class="text-lg font-semibold text-gray-900">Informations Rapides</h3>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-3 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Référence:</span>
                <span class="font-mono text-gray-900">{{ project.reference }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Type:</span>
                <span class="text-gray-900">{{ project.get_project_type_display|default:"Non spécifié" }}</span>
              </div>
              {% if project.surface_totale %}
              <div class="flex justify-between">
                <span class="text-gray-600">Surface:</span>
                <span class="text-gray-900">{{ project.surface_totale }}m²</span>
              </div>
              {% endif %}
              {% if project.nombre_pieces %}
              <div class="flex justify-between">
                <span class="text-gray-600">Pièces:</span>
                <span class="text-gray-900">{{ project.nombre_pieces }}</span>
              </div>
              {% endif %}
              {% if devis_list.count %}
              <div class="flex justify-between">
                <span class="text-gray-600">Devis:</span>
                <span class="text-gray-900">{{ devis_list.count }}</span>
              </div>
              {% endif %}
              <div class="flex justify-between">
                <span class="text-gray-600">Créé:</span>
                <span class="text-gray-900">{{ project.created_at|date:"d/m/Y" }}</span>
              </div>
              {% if project.assigned_to %}
              <div class="flex justify-between">
                <span class="text-gray-600">Assigné à:</span>
                <span class="text-gray-900">{{ project.assigned_to.get_full_name|default:project.assigned_to.username }}</span>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Actions rapides -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-bolt text-blue-600 text-xl"></i>
              <h3 class="text-lg font-semibold text-gray-900">Actions Rapides</h3>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-3">
              {% if can_edit %}
              <a
                href="{% url 'projects:projet_update' pk=project.pk %}"
                class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
              >
                <i class="fas fa-edit mr-2"></i>
                Modifier le projet
              </a>
              {% endif %}

              <a
                href="{% url 'projects:projet_list' %}"
                class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
              >
                <i class="fas fa-list mr-2"></i>
                Tous mes projets
              </a>

              {% if devis_list %}
              <a
                href="{% url 'projects:devis_list' %}"
                class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
              >
                <i class="fas fa-file-invoice-dollar mr-2"></i>
                Mes devis
              </a>
              {% endif %}

              <a
                href="{% url 'projects:projet_create_step1' %}"
                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
              >
                <i class="fas fa-plus mr-2"></i>
                Nouveau projet
              </a>
            </div>
          </div>
        </div>

        <!-- Timeline -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <i class="fas fa-history text-blue-600 text-xl"></i>
              <h3 class="text-lg font-semibold text-gray-900">Historique</h3>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              <div class="timeline-item">
                <div class="timeline-dot bg-green-500"></div>
                <div>
                  <div class="text-sm font-medium text-gray-900">Projet créé</div>
                  <div class="text-xs text-gray-600">{{ project.created_at|date:"d/m/Y à H:i" }}</div>
                </div>
              </div>

              {% if project.updated_at != project.created_at %}
              <div class="timeline-item">
                <div class="timeline-dot bg-blue-500"></div>
                <div>
                  <div class="text-sm font-medium text-gray-900">Dernière modification</div>
                  <div class="text-xs text-gray-600">{{ project.updated_at|date:"d/m/Y à H:i" }}</div>
                </div>
              </div>
              {% endif %} 
              
              {% for devis in devis_list %}
              <div class="timeline-item">
                <div class="timeline-dot {% if devis.status == 'accepte' %}bg-green-500 {% elif devis.status == 'refuse' %}bg-red-500 {% elif devis.status == 'envoye' %}bg-blue-500 {% else %}bg-gray-400{% endif %}"></div>
                <div>
                  <div class="text-sm font-medium text-gray-900">
                    Devis {{ devis.get_status_display|lower }}
                  </div>
                  <div class="text-xs text-gray-600">{{ devis.reference }}</div>
                  <div class="text-xs text-gray-600">{{ devis.created_at|date:"d/m/Y à H:i" }}</div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} 

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Animate progress circle
      const progressCircle = document.querySelector('.progress-ring circle:last-child');
      if (progressCircle) {
          let progress = 25; // Valor padrão
          
          // Calcular progresso baseado no status
          const status = '{{ project.status }}';
          switch(status) {
              case 'termine':
                  progress = 100;
                  break;
              case 'en_cours':
                  progress = 70;
                  break;
              case 'devis_accepte':
                  progress = 50;
                  break;
              case 'devis_envoye':
                  progress = 40;
                  break;
              case 'en_examen':
                  progress = 30;
                  break;
              default:
                  progress = 25;
          }
          
          const circumference = 2 * Math.PI * 40; // radius = 40
          const offset = circumference - (progress / 100) * circumference;

          // Animate from 100% to actual value
          progressCircle.style.strokeDashoffset = circumference;
          setTimeout(() => {
              progressCircle.style.transition = 'stroke-dashoffset 1s ease-in-out';
              progressCircle.style.strokeDashoffset = offset;
          }, 100);
      }

      // Auto-submit status form on change
      const statusSelect = document.querySelector('select[name="status"]');
      if (statusSelect) {
          statusSelect.addEventListener('change', function() {
              if (confirm('Changer le statut du projet ?')) {
                  this.form.submit();
              }
          });
      }

      // Confirmation for important actions
      const dangerButtons = document.querySelectorAll('[onclick*="confirm"]');
      dangerButtons.forEach(button => {
          button.addEventListener('click', function(e) {
              if (!confirm('Cette action est irréversible. Continuer ?')) {
                  e.preventDefault();
              }
          });
      });

      // Smooth scroll to sections
      const sectionLinks = document.querySelectorAll('a[href^="#"]');
      sectionLinks.forEach(link => {
          link.addEventListener('click', function(e) {
              e.preventDefault();
              const target = document.querySelector(this.getAttribute('href'));
              if (target) {
                  target.scrollIntoView({
                      behavior: 'smooth',
                      block: 'start'
                  });
              }
          });
      });
  });
</script>
{% endblock %}