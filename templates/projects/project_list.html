{% extends 'base_dashboard.html' %}
{% load static tailwind_tags %}

{% block title %}Mes Projets - LOPES PEINTURE{% endblock %}

{% block extra_css %}
{% tailwind_css %}
<style>
/* Estilos complementares específicos */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.animate-fade-in-up {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Notification styles */
.notification {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1000;
  max-width: 24rem;
  padding: 1rem;
  border-radius: 0.5rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  transform: translateX(100%);
  transition: transform 0.3s ease-in-out;
}

.notification.show {
  transform: translateX(0);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
  
  <!-- Header da Página -->
<div class="mb-8">
  <div class="space-y-6">
    
    <!-- Título e Actions - Layout responsivo -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      
      <!-- Título e Descrição -->
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-gradient-brand rounded-xl flex-center shadow-brand">
          <i class="fas fa-paint-brush text-xl text-white"></i>
        </div>
        <div>
          <h1 class="text-2xl lg:text-3xl font-display font-bold text-gray-900">
            Mes Projets de Peinture
          </h1>
          <p class="text-gray-600 mt-1 text-sm lg:text-base">
            Gérez et suivez tous vos projets en un seul endroit
          </p>
        </div>
      </div>

      <!-- Actions Header -->
      <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto sm:flex-shrink-0">
        <button
          onclick="toggleMobileFilters()"
          class="btn btn-secondary lg:hidden w-full sm:w-auto order-1"
        >
          <i class="fas fa-filter"></i>
          <span>Filtres</span>
        </button>
        
        <button
          onclick="exportProjects()"
          class="btn btn-secondary w-full sm:w-auto order-2"
          title="Exporter les projets"
        >
          <i class="fas fa-download"></i>
          <span class="sm:hidden">Export</span>
          <span class="hidden sm:inline">Exporter</span>
        </button>
        
        <a
          href="{% url 'projects:projet_create_step1' %}"
          class="btn btn-primary w-full sm:w-auto order-3"
        >
          <i class="fas fa-plus"></i>
          <span class="sm:hidden">Nouveau</span>
          <span class="hidden sm:inline">Nouveau Projet</span>
        </a>
      </div>
    </div>
    
    <!-- Statistiques rapides com animações -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
      
      <!-- Total de projetos -->
      <div class="card bg-brand-50 border-brand-200 p-3 sm:p-4 text-center hover:shadow-md transition-all duration-200 hover:scale-105">
        <div class="flex items-center justify-center mb-2">
          <div class="w-8 h-8 bg-brand-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-paint-brush text-brand-600 text-sm"></i>
          </div>
        </div>
        <div class="text-xl sm:text-2xl font-bold text-brand-600 mb-1" id="total-counter">
          {{ total_projects|default:0 }}
        </div>
        <div class="text-xs sm:text-sm text-brand-700 font-medium">
          Total
        </div>
        {% if debug_stats %}
        <div class="text-xs text-gray-500 mt-1">Debug: {{ debug_stats.total }}</div>
        {% endif %}
      </div>
      
      <!-- Projetos ativos -->
      <div class="card bg-success-50 border-success-200 p-3 sm:p-4 text-center hover:shadow-md transition-all duration-200 hover:scale-105">
        <div class="flex items-center justify-center mb-2">
          <div class="w-8 h-8 bg-success-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-play text-success-600 text-sm"></i>
          </div>
        </div>
        <div class="text-xl sm:text-2xl font-bold text-success-600 mb-1" id="active-counter">
          {{ active_projects|default:0 }}
        </div>
        <div class="text-xs sm:text-sm text-success-700 font-medium">
          En cours
        </div>
        {% if debug_stats %}
        <div class="text-xs text-gray-500 mt-1">Debug: {{ debug_stats.active }}</div>
        {% endif %}
      </div>
      
      <!-- Projetos pendentes -->
      <div class="card bg-warning-50 border-warning-200 p-3 sm:p-4 text-center hover:shadow-md transition-all duration-200 hover:scale-105">
        <div class="flex items-center justify-center mb-2">
          <div class="w-8 h-8 bg-warning-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-clock text-warning-600 text-sm"></i>
          </div>
        </div>
        <div class="text-xl sm:text-2xl font-bold text-warning-600 mb-1" id="pending-counter">
          {{ pending_projects|default:0 }}
        </div>
        <div class="text-xs sm:text-sm text-warning-700 font-medium">
          En attente
        </div>
        {% if debug_stats %}
        <div class="text-xs text-gray-500 mt-1">Debug: {{ debug_stats.pending }}</div>
        {% endif %}
      </div>
      
      <!-- Projetos terminados -->
      <div class="card bg-info-50 border-info-200 p-3 sm:p-4 text-center hover:shadow-md transition-all duration-200 hover:scale-105">
        <div class="flex items-center justify-center mb-2">
          <div class="w-8 h-8 bg-info-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-check-circle text-info-600 text-sm"></i>
          </div>
        </div>
        <div class="text-xl sm:text-2xl font-bold text-info-600 mb-1" id="completed-counter">
          {{ completed_projects|default:0 }}
        </div>
        <div class="text-xs sm:text-sm text-info-700 font-medium">
          Terminés
        </div>
        {% if debug_stats %}
        <div class="text-xs text-gray-500 mt-1">Debug: {{ debug_stats.completed }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Estatísticas detalhadas (opcional, para debug) -->
    {% if debug_stats and user.is_staff %}
    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <h4 class="font-semibold text-yellow-800 mb-2">
        <i class="fas fa-bug mr-2"></i>
        Debug - Estatísticas por Status:
      </h4>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
        {% for status, count in projects_by_status.items %}
        <div class="bg-white p-2 rounded border">
          <div class="font-medium text-gray-700">{{ status }}</div>
          <div class="text-lg font-bold text-blue-600">{{ count }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Filter Chips (Filtros Ativos) -->
    <div id="filter-chips" class="hidden"></div>

  </div>
</div>

  <!-- Layout Principal -->
  <div class="flex flex-col lg:flex-row gap-8">
    
    <!-- Sidebar Filtros -->
    <div class="lg:w-80">
      <div id="filters-sidebar" class="card sticky top-6 hidden lg:block p-5">
        <div class="flex items-center gap-3 mb-6">
          <div class="icon icon-lg bg-brand-100 rounded-lg text-brand-600 flex-center">
            <i class="fas fa-filter"></i>
          </div>
          <h3 class="text-lg font-display font-bold text-gray-900">Filtres de Recherche</h3>
        </div>
        
        <form method="get" id="filter-form" class="space-y-6">
          {% csrf_token %}
          
          <!-- Recherche générale -->
          <div class="form-group">
            <label class="form-label flex items-center gap-2">
              <i class="icon icon-sm fas fa-search text-gray-400"></i>
              Recherche générale
            </label>
            <input
              type="text"
              name="search"
              value="{{ request.GET.search|default:'' }}"
              placeholder="Titre, ville, référence..."
              class="form-input"
            />
          </div>

          <!-- Status -->
          <div class="form-group">
            <label class="form-label flex items-center gap-2">
              <i class="icon icon-sm fas fa-flag text-gray-400"></i>
              Statut du projet
            </label>
            <select name="status" class="form-input form-select">
              <option value="">Tous les statuts</option>
              <option value="brouillon" {% if request.GET.status == 'brouillon' %}selected{% endif %}>Brouillon</option>
              <option value="soumis" {% if request.GET.status == 'soumis' %}selected{% endif %}>Soumis</option>
              <option value="en_examen" {% if request.GET.status == 'en_examen' %}selected{% endif %}>En examen</option>
              <option value="devis_demande" {% if request.GET.status == 'devis_demande' %}selected{% endif %}>Devis demandé</option>
              <option value="devis_envoye" {% if request.GET.status == 'devis_envoye' %}selected{% endif %}>Devis envoyé</option>
              <option value="devis_accepte" {% if request.GET.status == 'devis_accepte' %}selected{% endif %}>Devis accepté</option>
              <option value="en_cours" {% if request.GET.status == 'en_cours' %}selected{% endif %}>En cours</option>
              <option value="termine" {% if request.GET.status == 'termine' %}selected{% endif %}>Terminé</option>
            </select>
          </div>

          <!-- Outros campos de filtro aqui... -->

          <!-- Botões de ação -->
          <div class="space-y-3 pt-6 border-t border-gray-200">
            <button type="submit" class="btn btn-primary w-full">
              <i class="fas fa-search"></i>
              Appliquer les filtres
            </button>
            <a href="{% url 'projects:projet_list' %}" class="btn btn-secondary w-full text-center">
              <i class="fas fa-refresh"></i>
              Réinitialiser
            </a>
          </div>
        </form>

        <!-- Filtres rápidos -->
        <div class="mt-8 pt-6 border-t border-gray-200">
          <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-lightning text-brand-600"></i>
            Accès rapide
          </h4>
          <div class="space-y-2">
            <a href="?status=en_cours" class="nav-link flex items-center gap-3">
              <div class="w-2 h-2 bg-success-500 rounded-full"></div>
              Projets en cours
            </a>
            <a href="?priority=urgente" class="nav-link flex items-center gap-3">
              <div class="w-2 h-2 bg-danger-500 rounded-full"></div>
              Projets urgents
            </a>
            <a href="?status=devis_demande" class="nav-link flex items-center gap-3">
              <div class="w-2 h-2 bg-warning-500 rounded-full"></div>
              Devis en attente
            </a>
            <a href="?date_from={{ last_week|date:'Y-m-d' }}" class="nav-link flex items-center gap-3">
              <div class="w-2 h-2 bg-info-500 rounded-full"></div>
              Projets récents
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenu Principal -->
    <div class="flex-1 min-w-0">
      
      <!-- Header des résultats -->
      <div class="card mb-6">
        <div class="card-body">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div class="flex-1">
              <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="results-info">
                  <h2 class="text-lg font-display font-semibold text-gray-900">
                    {% if projects %}
                      {{ paginator.count }} projet{{ paginator.count|pluralize }} trouvé{{ paginator.count|pluralize }}
                    {% else %}
                      Aucun projet trouvé
                    {% endif %}
                  </h2>
                  {% if request.GET %}
                  <p class="text-sm text-gray-500 mt-1 flex items-center gap-2">
                    <i class="fas fa-filter text-brand-500"></i>
                    Résultats filtrés
                    <a href="{% url 'projects:projet_list' %}" class="text-brand-600 hover:text-brand-700 font-medium underline">
                      Voir tous
                    </a>
                  </p>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- Contrôles de vue e tri -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
              
              <!-- Tri -->
              <div class="flex items-center gap-2 w-full sm:w-auto">
                <label class="form-label !mb-0 text-sm font-medium text-gray-700 whitespace-nowrap hidden sm:block">
                  Trier par:
                </label>
                <label class="form-label !mb-0 text-sm font-medium text-gray-700 sm:hidden">
                  Tri:
                </label>
                <select
                  name="ordering"
                  onchange="changeSorting(this.value)"
                  class="form-input form-select !mb-0 flex-1 sm:flex-initial"
                >
                  <option value="-created_at" {% if request.GET.ordering == '-created_at' %}selected{% endif %}>Plus récent</option>
                  <option value="created_at" {% if request.GET.ordering == 'created_at' %}selected{% endif %}>Plus ancien</option>
                  <option value="title" {% if request.GET.ordering == 'title' %}selected{% endif %}>Titre A-Z</option>
                  <option value="-title" {% if request.GET.ordering == '-title' %}selected{% endif %}>Titre Z-A</option>
                  <option value="priority" {% if request.GET.ordering == 'priority' %}selected{% endif %}>Priorité</option>
                  <option value="-surface_totale" {% if request.GET.ordering == '-surface_totale' %}selected{% endif %}>Surface ↓</option>
                </select>
              </div>

              <!-- Toggle de vue -->
              <div class="flex items-center justify-center sm:justify-start w-full sm:w-auto">
                <div class="flex items-center gap-0 bg-gray-100 p-1 rounded-lg w-full sm:w-auto">
                  <button
                    onclick="setView('grid')"
                    id="grid-view-btn"
                    class="btn btn-sm bg-white text-brand-600 shadow-sm flex-1 sm:flex-initial"
                    title="Vue grille"
                  >
                    <i class="fas fa-th-large sm:mr-1"></i>
                    <span class="hidden sm:inline">Grille</span>
                  </button>
                  <button
                    onclick="setView('list')"
                    id="list-view-btn"
                    class="btn btn-ghost btn-sm flex-1 sm:flex-initial"
                    title="Vue liste"
                  >
                    <i class="fas fa-list sm:mr-1"></i>
                    <span class="hidden sm:inline">Liste</span>
                  </button>
                </div>
              </div>
              
              <!-- Botão de filtros mobile -->
              <div class="sm:hidden w-full">
                <button
                  onclick="toggleMobileFilters()"
                  class="btn btn-secondary w-full"
                >
                  <i class="fas fa-filter mr-2"></i>
                  Filtres avancés
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grid/Lista de Projetos -->
{% if projects %}
<div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6">
  {% for project in projects %}
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200 animate-fade-in-up" 
       data-project-id="{{ project.pk }}" 
       style="animation-delay: {{ forloop.counter0|floatformat:1 }}00ms">
    
    <!-- Header do Card -->
    <div class="p-4 border-b border-gray-100">
      <div class="flex items-start justify-between gap-3 mb-3">
        <div class="flex-1 min-w-0">
          <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2">
            <a
              href="{% url 'projects:projet_detail' pk=project.pk %}"
              class="hover:text-blue-600 transition-colors duration-200"
              title="{{ project.title }}"
            >
              {{ project.title }}
            </a>
          </h3>
          <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
            <i class="fas fa-hashtag mr-1"></i>
            {{ project.reference }}
          </div>
        </div>
        
        <!-- Status Badge -->
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium flex-shrink-0
          {% if project.status == 'brouillon' %}bg-gray-100 text-gray-800
          {% elif project.status == 'soumis' %}bg-blue-100 text-blue-800
          {% elif project.status == 'en_examen' %}bg-yellow-100 text-yellow-800
          {% elif project.status == 'devis_demande' %}bg-orange-100 text-orange-800
          {% elif project.status == 'devis_envoye' %}bg-purple-100 text-purple-800
          {% elif project.status == 'devis_accepte' %}bg-green-100 text-green-800
          {% elif project.status == 'en_cours' %}bg-blue-100 text-blue-800
          {% elif project.status == 'termine' %}bg-emerald-100 text-emerald-800
          {% else %}bg-gray-100 text-gray-800{% endif %}">
          <i class="fas fa-circle text-xs mr-1"></i>
          {{ project.get_status_display }}
        </span>
      </div>

      <div class="flex items-center justify-between">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border
          {% if project.priority == 'urgente' %}text-red-800 border-red-300 bg-red-50
          {% elif project.priority == 'elevee' %}text-orange-800 border-orange-300 bg-orange-50
          {% elif project.priority == 'normale' %}text-blue-800 border-blue-300 bg-blue-50
          {% else %}text-gray-800 border-gray-300 bg-gray-50{% endif %}">
          <i class="fas fa-flag mr-1"></i>
          {{ project.get_priority_display }}
        </span>

        <div class="text-xs text-gray-500 flex items-center gap-1">
          <i class="fas fa-calendar-alt"></i>
          {{ project.created_at|date:"d/m/Y" }}
        </div>
      </div>
    </div>

    <!-- Conteúdo do Card -->
    <div class="p-4 space-y-4">
      
      <!-- Informações principais -->
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <i class="fas fa-paint-brush text-blue-500 text-sm"></i>
            <span class="font-medium text-blue-900 text-xs">Type</span>
          </div>
          <div class="text-blue-800 font-semibold text-xs truncate">
            {{ project.project_type }}
          </div>
        </div>

        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
          <div class="flex items-center gap-2 mb-1">
            <i class="fas fa-ruler-combined text-green-500 text-sm"></i>
            <span class="font-medium text-green-900 text-xs">Surface</span>
          </div>
          <div class="text-green-800 font-semibold text-xs">
            {{ project.surface_totale|default:"--" }} m²
          </div>
        </div>
      </div>

      <!-- Localização -->
      {% if project.ville %}
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
        <div class="flex items-center gap-2 text-sm">
          <i class="fas fa-map-marker-alt text-red-500"></i>
          <span class="font-medium text-gray-700 truncate">
            {{ project.ville }}{% if project.code_postal %}, {{ project.code_postal }}{% endif %}
          </span>
        </div>
      </div>
      {% endif %}

      <!-- Descrição -->
      {% if project.description %}
      <div class="text-sm text-gray-600 bg-gray-50 border border-gray-200 rounded-lg p-3">
        <p class="line-clamp-2">{{ project.description|truncatechars:100 }}</p>
      </div>
      {% endif %}

      <!-- Budget estimé -->
      {% if project.budget_minimum or project.budget_maximum %}
      <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-orange-200 rounded-lg p-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-euro-sign text-orange-600"></i>
            <span class="text-sm font-medium text-orange-900">Budget</span>
          </div>
          <span class="font-bold text-sm text-orange-800">
            {% if project.budget_minimum and project.budget_maximum %}
              {{ project.budget_minimum|floatformat:0 }}€ - {{ project.budget_maximum|floatformat:0 }}€
            {% elif project.budget_minimum %}
              À partir de {{ project.budget_minimum|floatformat:0 }}€
            {% elif project.budget_maximum %}
              Jusqu'à {{ project.budget_maximum|floatformat:0 }}€
            {% endif %}
          </span>
        </div>
      </div>
      {% endif %}

      <!-- Progress bar (apenas para projetos em curso) -->
      {% if project.status == 'en_cours' %}
      <div class="space-y-2">
        <div class="flex justify-between text-sm">
          <span class="text-gray-700 font-medium flex items-center gap-2">
            <i class="fas fa-tasks text-blue-500"></i>
            Progression
          </span>
          <span class="text-blue-600 font-bold">{{ project.progress_percentage|default:0 }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div 
            class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500" 
            style="width: {{ project.progress_percentage|default:0 }}%"
          ></div>
        </div>
      </div>
      {% endif %}

      <!-- Dates importantes -->
      {% if project.date_debut_souhaitee or project.date_fin_souhaitee %}
      <div class="flex items-center gap-4 text-xs text-gray-600 bg-blue-50 border border-blue-200 rounded-lg p-2">
        {% if project.date_debut_souhaitee %}
        <div class="flex items-center gap-1">
          <i class="fas fa-play text-green-500"></i>
          <span>Début: {{ project.date_debut_souhaitee|date:"d/m/Y" }}</span>
        </div>
        {% endif %}
        {% if project.date_fin_souhaitee %}
        <div class="flex items-center gap-1">
          <i class="fas fa-flag-checkered text-red-500"></i>
          <span>Fin: {{ project.date_fin_souhaitee|date:"d/m/Y" }}</span>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Footer do Card -->
    <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 rounded-b-lg">
      <div class="flex items-center justify-between">
        <!-- Info adicional -->
        <div class="text-xs text-gray-500 flex items-center gap-3">
          {% if project.nombre_pieces %}
          <span class="flex items-center gap-1">
            <i class="fas fa-door-open"></i>
            {{ project.nombre_pieces }} pièce{{ project.nombre_pieces|pluralize }}
          </span>
          {% endif %}
          {% if project.updated_at != project.created_at %}
          <span class="flex items-center gap-1 hidden sm:flex">
            <i class="fas fa-edit"></i>
            Modifié {{ project.updated_at|date:"d/m" }}
          </span>
          {% endif %}
        </div>
        
        <!-- Actions -->
        <div class="flex items-center gap-1">
          <button
            onclick="toggleFavorite('{{ project.pk }}')"
            class="p-2 text-gray-400 hover:text-yellow-500 hover:bg-yellow-50 rounded-full transition-colors duration-200"
            title="Marquer comme favori"
          >
            <i class="fas fa-star text-sm"></i>
          </button>
          
          <a
            href="{% url 'projects:projet_detail' pk=project.pk %}"
            class="p-2 text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-full transition-colors duration-200"
            title="Voir détails"
          >
            <i class="fas fa-eye text-sm"></i>
          </a>
          
          {% if project.user == request.user or request.user.is_staff %}
          <a
            href="{% url 'projects:projet_update' pk=project.pk %}"
            class="p-2 text-orange-600 hover:text-orange-700 hover:bg-orange-50 rounded-full transition-colors duration-200"
            title="Modifier"
          >
            <i class="fas fa-edit text-sm"></i>
          </a>
          {% endif %}

          {% if project.status == 'soumis' and project.can_request_quote %}
          <button
            onclick="requestQuote('{{ project.pk }}')"
            class="p-2 text-green-600 hover:text-green-700 hover:bg-green-50 rounded-full transition-colors duration-200"
            title="Demander un devis"
          >
            <i class="fas fa-file-invoice-dollar text-sm"></i>
          </button>
          {% endif %}

          <!-- Menu dropdown para ações extras -->
          <div class="relative">
            <button
              onclick="toggleProjectMenu(this)"
              class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors duration-200"
              title="Plus d'actions"
            >
              <i class="fas fa-ellipsis-v text-sm"></i>
            </button>
            
            <!-- Dropdown menu -->
            <div class="hidden absolute right-0 bottom-full mb-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
              <div class="py-1">
                <button
                  onclick="shareProject('{{ project.pk }}', '{{ project.title|escapejs }}')"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                >
                  <i class="fas fa-share-alt text-blue-500"></i>
                  Partager
                </button>
                
                <button
                  onclick="duplicateProject('{{ project.pk }}')"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                >
                  <i class="fas fa-copy text-green-500"></i>
                  Dupliquer
                </button>
                
                <button
                  onclick="exportProject('{{ project.pk }}')"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"
                >
                  <i class="fas fa-download text-purple-500"></i>
                  Exporter PDF
                </button>
                
                {% if project.status == 'brouillon' and project.user == request.user %}
                <div class="border-t border-gray-100"></div>
                <button
                  onclick="deleteProject('{{ project.pk }}')"
                  class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                >
                  <i class="fas fa-trash text-red-500"></i>
                  Supprimer
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="mt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
  <div class="text-sm text-gray-700">
    Affichage de {{ page_obj.start_index }} à {{ page_obj.end_index }} sur {{ paginator.count }} résultats
  </div>
  
  <nav class="flex items-center gap-2">
    {% if page_obj.has_previous %}
    <a
      href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1"
      class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
    >
      <i class="fas fa-angle-double-left"></i>
    </a>
    <a
      href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}"
      class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
    >
      <i class="fas fa-angle-left"></i>
    </a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
      <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">
        {{ num }}
      </span>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
      <a
        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}"
        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
      >
        {{ num }}
      </a>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <a
      href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}"
      class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
    >
      <i class="fas fa-angle-right"></i>
    </a>
    <a
      href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ paginator.num_pages }}"
      class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
    >
      <i class="fas fa-angle-double-right"></i>
    </a>
    {% endif %}
  </nav>
</div>
{% endif %}

{% else %}
<!-- Estado Vazio -->
<div class="text-center py-12">
  <div class="max-w-md mx-auto">
    <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
      <i class="fas fa-paint-brush text-3xl text-gray-400"></i>
    </div>
    
    <h3 class="text-lg font-medium text-gray-900 mb-2">
      {% if request.GET %}
        Aucun projet trouvé
      {% else %}
        Aucun projet pour le moment
      {% endif %}
    </h3>
    
    <p class="text-gray-500 mb-6">
      {% if request.GET %}
        Essayez de modifier vos critères de recherche ou de supprimer certains filtres.
      {% else %}
        Commencez par créer votre premier projet de peinture.
      {% endif %}
    </p>
    
    <div class="space-y-3">
      {% if request.GET %}
      <a
        href="{% url 'projects:projet_list' %}"
        class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
      >
        <i class="fas fa-times mr-2"></i>
        Supprimer les filtres
      </a>
      {% endif %}
      
      <a
        href="{% url 'projects:projet_create_step1' %}"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
      >
        <i class="fas fa-plus mr-2"></i>
        Créer mon premier projet
      </a>
    </div>
  </div>
</div>
{% endif %}
    </div>
  </div>
</div>

<!-- Modal Mobile Filtros -->
<div id="mobile-filters-modal" class="modal-overlay lg:hidden hidden">
  <div class="modal transform -translate-x-full transition-transform duration-300 ease-in-out">
    <div class="modal-header">
      <h3 class="modal-title flex items-center gap-2">
        <i class="fas fa-filter text-brand-600"></i>
        Filtres
      </h3>
      <button onclick="toggleMobileFilters()" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="p-6">
      <form method="get" class="space-y-6">
        <!-- Recherche générale -->
        <div class="form-group">
          <label class="form-label">Recherche générale</label>
          <input type="text" name="search" class="form-input" placeholder="Titre, ville, référence..." value="{{ request.GET.search|default:'' }}">
        </div>
        
        <!-- Status -->
        <div class="form-group">
          <label class="form-label">Statut du projet</label>
          <select name="status" class="form-input form-select">
            <option value="">Tous les statuts</option>
            <option value="brouillon" {% if request.GET.status == 'brouillon' %}selected{% endif %}>Brouillon</option>
            <option value="soumis" {% if request.GET.status == 'soumis' %}selected{% endif %}>Soumis</option>
            <option value="en_examen" {% if request.GET.status == 'en_examen' %}selected{% endif %}>En examen</option>
            <option value="devis_demande" {% if request.GET.status == 'devis_demande' %}selected{% endif %}>Devis demandé</option>
            <option value="devis_envoye" {% if request.GET.status == 'devis_envoye' %}selected{% endif %}>Devis envoyé</option>
            <option value="devis_accepte" {% if request.GET.status == 'devis_accepte' %}selected{% endif %}>Devis accepté</option>
            <option value="en_cours" {% if request.GET.status == 'en_cours' %}selected{% endif %}>En cours</option>
            <option value="termine" {% if request.GET.status == 'termine' %}selected{% endif %}>Terminé</option>
          </select>
        </div>
        
        <div class="pt-6 border-t border-gray-200 space-y-3">
          <button type="submit" class="btn btn-primary w-full">
            <i class="fas fa-search"></i>
            Appliquer les filtres
          </button>
          <button type="button" onclick="toggleMobileFilters()" class="btn btn-secondary w-full">
            Fermer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'projects/js/project_list.js' %}"></script>
<!-- JavaScript para funcionalidades interativas -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Fechar dropdowns ao clicar fora
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.relative')) {
      document.querySelectorAll('.relative .absolute').forEach(menu => {
        menu.classList.add('hidden');
      });
    }
  });
});

// Função para toggle do menu de ações
function toggleProjectMenu(button) {
  const menu = button.nextElementSibling;
  const isHidden = menu.classList.contains('hidden');
  
  // Fechar todos os outros menus
  document.querySelectorAll('.relative .absolute').forEach(otherMenu => {
    otherMenu.classList.add('hidden');
  });
  
  // Toggle do menu atual
  if (isHidden) {
    menu.classList.remove('hidden');
  } else {
    menu.classList.add('hidden');
  }
}

// Função para favoritar projeto
function toggleFavorite(projectId) {
  // Implementar lógica de favoritos
  console.log('Toggle favorite for project:', projectId);
}

// Função para solicitar devis
function requestQuote(projectId) {
  if (confirm('Demander un devis pour ce projet ?')) {
    // Implementar lógica de solicitação de devis
    console.log('Request quote for project:', projectId);
  }
}

// Função para compartilhar projeto
function shareProject(projectId, projectTitle) {
  if (navigator.share) {
    navigator.share({
      title: projectTitle,
      text: 'Découvrez mon projet de peinture',
      url: window.location.origin + '/projets/' + projectId + '/'
    });
  } else {
    // Fallback para navegadores sem suporte a Web Share API
    const url = window.location.origin + '/projets/' + projectId + '/';
    navigator.clipboard.writeText(url).then(() => {
      showNotification('Lien copié dans le presse-papiers!', 'success');
    });
  }
}

// Função para duplicar projeto
function duplicateProject(projectId) {
  if (confirm('Dupliquer ce projeto ?')) {
    // Implementar lógica de duplicação
    console.log('Duplicate project:', projectId);
  }
}

// Função para exportar projeto
function exportProject(projectId) {
  // Implementar lógica de exportação PDF
  console.log('Export project:', projectId);
}

// Função para deletar projeto
function deleteProject(projectId) {
  if (confirm('Êtes-vous sûr de vouloir supprimer ce projet ? Cette action est irréversible.')) {
    // Implementar lógica de exclusão
    console.log('Delete project:', projectId);
  }
}

// Função para mostrar notificações
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification show bg-${type === 'success' ? 'green' : 'blue'}-500 text-white`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Adicionar após o DOMContentLoaded existente:

// Animação dos contadores
function animateCounters() {
  const counters = [
    { element: document.getElementById('total-counter'), target: {{ total_projects|default:0 }} },
    { element: document.getElementById('active-counter'), target: {{ active_projects|default:0 }} },
    { element: document.getElementById('pending-counter'), target: {{ pending_projects|default:0 }} },
    { element: document.getElementById('completed-counter'), target: {{ completed_projects|default:0 }} }
  ];

  counters.forEach(({ element, target }) => {
    if (!element) return;
    
    let current = 0;
    const increment = target / 30; // 30 frames para animação
    const timer = setInterval(() => {
      current += increment;
      if (current >= target) {
        element.textContent = target;
        clearInterval(timer);
      } else {
        element.textContent = Math.floor(current);
      }
    }, 50); // 50ms entre frames
  });
}

// Executar animação quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
  // Animar contadores após um pequeno delay
  setTimeout(animateCounters, 300);
});
</script>
{% endblock %}