{% extends 'base_dashboard.html' %} {% load static %} {% block title %}Modifier mon Profil - {{
user.get_full_name }} - {{ block.super }}{% endblock %} {% block extra_css %}
<style>
  /* ✅ CORRIGIDO: CSS para evitar sobreposições */
  .form-field {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .form-field .field-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    z-index: 10;
    pointer-events: none;
  }

  .form-field.has-textarea .field-icon {
    top: 1rem;
    transform: none;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    transition: all 0.2s;
    background-color: white;
  }

  .form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-input.error {
    border-color: #ef4444;
  }

  .custom-file-upload {
    display: inline-block;
    padding: 0.5rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    background-color: white;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s;
  }

  .custom-file-upload:hover {
    background-color: #f9fafb;
    border-color: #d1d5db;
  }

  .avatar-preview {
    width: 5rem;
    height: 5rem;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #e5e7eb;
  }

  .avatar-placeholder {
    width: 5rem;
    height: 5rem;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #6366f1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.125rem;
    border: 4px solid #e5e7eb;
  }
</style>
{% endblock %} {% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <!-- Header -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <a
          href="{% url 'profiles:detail' %}"
          class="text-gray-500 hover:text-gray-700 transition-colors"
        >
          <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Modifier mon Profil</h1>
          <p class="text-gray-600 mt-1">Mettez à jour vos informations personnelles</p>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="text-sm text-gray-600">
          Complétude: <strong>{{ completion_percentage }}%</strong>
        </span>
        <a
          href="{% url 'profiles:detail' %}"
          class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
        >
          <i class="fas fa-eye mr-2"></i>
          Voir le profil
        </a>
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-6">
    {% for message in messages %}
    <div
      class="rounded-lg p-4 mb-4 {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% elif message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}"
    >
      <div class="flex items-center">
        <i
          class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} mr-2"
        ></i>
        {{ message }}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Formulário -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <form method="post" enctype="multipart/form-data" class="space-y-8" novalidate>
      {% csrf_token %}

     

      <!-- ✅ Seção: Photo de profil -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-camera mr-3 text-blue-600"></i>
            Photo de profil
          </h2>
          <p class="mt-1 text-sm text-gray-600">
            Ajoutez une photo pour personnaliser votre profil
          </p>
        </div>

        <div class="p-6">
          <div class="flex items-center space-x-6">
            <!-- Avatar atual -->
            <div class="flex-shrink-0">
              {% if profile.avatar %}
              <img
                id="avatar-preview"
                class="avatar-preview"
                src="{{ profile.avatar.url }}"
                alt="{{ user.get_full_name }}"
              />
              {% else %}
              <div id="avatar-preview" class="avatar-placeholder">{{ profile.initials }}</div>
              {% endif %}
            </div>

            <!-- Upload -->
            <div class="flex-1">
              <div class="form-field">
                {{ form.avatar }}
                <label for="{{ form.avatar.id_for_label }}" class="custom-file-upload">
                  <i class="fas fa-upload mr-2"></i>
                  Choisir une photo
                </label>
              </div>

              <p class="mt-2 text-xs text-gray-500">{{ form.avatar.help_text }}</p>

              {% if form.avatar.errors %}
              <div class="mt-2 text-sm text-red-600">
                {% for error in form.avatar.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Seção: Informations de contact -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-address-book mr-3 text-blue-600"></i>
            Informations de contact
          </h2>
          <p class="mt-1 text-sm text-gray-600">Vos coordonnées pour faciliter la communication</p>
        </div>

        <div class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Téléphone -->
            <div class="lg:col-span-2">
              <label
                for="{{ form.phone.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-phone mr-2 text-blue-500"></i>
                {{ form.phone.label }} {% if form.phone.field.required %}<span class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                <i class="fas fa-phone field-icon"></i>
                <input
                  type="tel"
                  id="{{ form.phone.id_for_label }}"
                  name="{{ form.phone.html_name }}"
                  value="{{ form.phone.value|default:'' }}"
                  placeholder="{{ form.phone.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.phone.field.widget.attrs.autocomplete }}"
                  class="form-input {% if form.phone.errors %}error{% endif %}"
                />
              </div>

              {% if form.phone.help_text %}
              <p class="mt-1 text-xs text-gray-500">{{ form.phone.help_text }}</p>
              {% endif %} {% if form.phone.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.phone.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Adresse -->
            <div class="lg:col-span-2">
              <label
                for="{{ form.address.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                {{ form.address.label }} {% if form.address.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field has-textarea">
                <i class="fas fa-map-marker-alt field-icon"></i>
                <textarea
                  id="{{ form.address.id_for_label }}"
                  name="{{ form.address.html_name }}"
                  placeholder="{{ form.address.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.address.field.widget.attrs.autocomplete }}"
                  rows="3"
                  class="form-input {% if form.address.errors %}error{% endif %}"
                >
{{ form.address.value|default:'' }}</textarea
                >
              </div>

              {% if form.address.help_text %}
              <p class="mt-1 text-xs text-gray-500">{{ form.address.help_text }}</p>
              {% endif %} {% if form.address.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.address.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Ville -->
            <div>
              <label
                for="{{ form.city.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-city mr-2 text-blue-500"></i>
                {{ form.city.label }} {% if form.city.field.required %}<span class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                <i class="fas fa-city field-icon"></i>
                <input
                  type="text"
                  id="{{ form.city.id_for_label }}"
                  name="{{ form.city.html_name }}"
                  value="{{ form.city.value|default:'' }}"
                  placeholder="{{ form.city.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.city.field.widget.attrs.autocomplete }}"
                  class="form-input {% if form.city.errors %}error{% endif %}"
                />
              </div>

              {% if form.city.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.city.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Code postal -->
            <div>
              <label
                for="{{ form.postal_code.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-mail-bulk mr-2 text-blue-500"></i>
                {{ form.postal_code.label }} {% if form.postal_code.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                <i class="fas fa-mail-bulk field-icon"></i>
                <input
                  type="text"
                  id="{{ form.postal_code.id_for_label }}"
                  name="{{ form.postal_code.html_name }}"
                  value="{{ form.postal_code.value|default:'' }}"
                  placeholder="{{ form.postal_code.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.postal_code.field.widget.attrs.autocomplete }}"
                  maxlength="5"
                  pattern="[0-9]{5}"
                  class="form-input {% if form.postal_code.errors %}error{% endif %}"
                />
              </div>

              {% if form.postal_code.help_text %}
              <p class="mt-1 text-xs text-gray-500">{{ form.postal_code.help_text }}</p>
              {% endif %} {% if form.postal_code.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.postal_code.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Pays -->
            <div class="lg:col-span-2">
              <label
                for="{{ form.country.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-flag mr-2 text-blue-500"></i>
                {{ form.country.label }} {% if form.country.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                <i class="fas fa-flag field-icon"></i>
                <input
                  type="text"
                  id="{{ form.country.id_for_label }}"
                  name="{{ form.country.html_name }}"
                  value="{{ form.country.value|default:'' }}"
                  placeholder="{{ form.country.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.country.field.widget.attrs.autocomplete }}"
                  class="form-input {% if form.country.errors %}error{% endif %}"
                />
              </div>

              {% if form.country.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.country.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Seção: Préférences -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-cog mr-3 text-blue-600"></i>
            Préférences de communication
          </h2>
          <p class="mt-1 text-sm text-gray-600">Gérez vos notifications et communications</p>
        </div>

        <div class="p-6">
          <div class="space-y-4">
            <!-- Notifications -->
            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200"
            >
              <div class="flex items-center">
                <i class="fas fa-bell text-blue-500 mr-3"></i>
                <div>
                  <label
                    for="{{ form.receive_notifications.id_for_label }}"
                    class="text-sm font-medium text-gray-900 cursor-pointer"
                  >
                    {{ form.receive_notifications.label }}
                  </label>
                  <p class="text-sm text-gray-500">{{ form.receive_notifications.help_text }}</p>
                </div>
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="{{ form.receive_notifications.id_for_label }}"
                  name="{{ form.receive_notifications.html_name }}"
                  {%
                  if
                  form.receive_notifications.value
                  %}checked{%
                  endif
                  %}
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded transition-colors"
                />
              </div>
            </div>

            <!-- Newsletter -->
            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200"
            >
              <div class="flex items-center">
                <i class="fas fa-newspaper text-blue-500 mr-3"></i>
                <div>
                  <label
                    for="{{ form.receive_newsletters.id_for_label }}"
                    class="text-sm font-medium text-gray-900 cursor-pointer"
                  >
                    {{ form.receive_newsletters.label }}
                  </label>
                  <p class="text-sm text-gray-500">{{ form.receive_newsletters.help_text }}</p>
                </div>
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="{{ form.receive_newsletters.id_for_label }}"
                  name="{{ form.receive_newsletters.html_name }}"
                  {%
                  if
                  form.receive_newsletters.value
                  %}checked{%
                  endif
                  %}
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded transition-colors"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Botões de ação -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6">
          <div
            class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4"
          >
            <!-- Informações -->
            <div class="flex items-center text-sm text-gray-600">
              <i class="fas fa-info-circle mr-2 text-blue-500"></i>
              <span>Toutes les modifications sont sauvegardées instantanément</span>
            </div>

            <!-- Botões -->
            <div class="flex items-center space-x-3">
              <a
                href="{% url 'profiles:detail' %}"
                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
              >
                <i class="fas fa-times mr-2"></i>
                Annuler
              </a>

              <!-- ✅ SUBSTITUIR O BOTÃO EXISTENTE POR ESTE: -->
              <div class="flex justify-end">
                <!-- Botão básico sem classes especiais -->
                <input
                  type="submit"
                  value="Enregistrer les modifications"
                  class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 cursor-pointer"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- ✅ Seção de ajuda -->
    <div class="mt-8 bg-blue-50 rounded-xl border border-blue-200 p-6">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-lightbulb text-blue-600 text-xl"></i>
        </div>
        <div class="ml-4">
          <h3 class="text-sm font-medium text-blue-900">Conseils pour un profil complet</h3>
          <div class="mt-2 text-sm text-blue-800">
            <ul class="list-disc list-inside space-y-1">
              <li>Ajoutez une photo de profil professionnelle</li>
              <li>Renseignez vos coordonnées pour faciliter la communication</li>
              <li>Activez les notifications pour ne rien manquer</li>
              <li>Votre adresse aide à personnaliser nos services</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // ✅ CORRIGIDO: JavaScript sem conflitos
  document.addEventListener('DOMContentLoaded', function () {
    // Preview da imagem do avatar
    const avatarInput = document.getElementById('{{ form.avatar.id_for_label }}');
    const avatarPreview = document.getElementById('avatar-preview');

    if (avatarInput && avatarPreview) {
      avatarInput.addEventListener('change', function (e) {
        const file = e.target.files[0];

        if (file) {
          // Verificar tipo de arquivo
          if (!file.type.startsWith('image/')) {
            alert('Veuillez sélectionner un fichier image valide.');
            this.value = '';
            return;
          }

          // Verificar tamanho (2MB = 2097152 bytes)
          if (file.size > 2097152) {
            alert('La taille du fichier ne doit pas dépasser 2MB.');
            this.value = '';
            return;
          }

          // Preview da imagem
          const reader = new FileReader();
          reader.onload = function (e) {
            // Criar ou atualizar img elemento
            if (avatarPreview.tagName === 'DIV') {
              // Substituir div por img
              const img = document.createElement('img');
              img.id = 'avatar-preview';
              img.className = 'avatar-preview';
              img.src = e.target.result;
              img.alt = '{{ user.get_full_name }}';
              avatarPreview.parentNode.replaceChild(img, avatarPreview);
            } else {
              // Atualizar img existente
              avatarPreview.src = e.target.result;
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Auto-formatação do telefone francês
    const phoneInput = document.getElementById('{{ form.phone.id_for_label }}');
    if (phoneInput) {
      phoneInput.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');

        // Formatação automática
        if (value.length === 10 && value.startsWith('0')) {
          value = '+33' + value.substring(1);
        }

        if (value.startsWith('33') && !value.startsWith('+33')) {
          value = '+' + value;
        }

        // Aplicar formatação: +33 1 23 45 67 89
        if (value.startsWith('+33') && value.length >= 12) {
          value = value.replace(/(\+33)(\d{1})(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4 $5 $6');
        }

        e.target.value = value;
      });
    }

    // Validação do código postal francês
    const postalInput = document.getElementById('{{ form.postal_code.id_for_label }}');
    if (postalInput) {
      postalInput.addEventListener('input', function (e) {
        // Permitir apenas números
        e.target.value = e.target.value.replace(/\D/g, '');

        // Limitar a 5 dígitos
        if (e.target.value.length > 5) {
          e.target.value = e.target.value.substring(0, 5);
        }
      });
    }

    // Loading no botão de submit
    const form = document.querySelector('form');
    const submitButton = document.getElementById('submit-button');

    if (form && submitButton) {
      form.addEventListener('submit', function (e) {
        // Mostrar loading
        submitButton.disabled = true;
        submitButton.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Sauvegarde en cours...';

        // Fallback para reativar botão
        setTimeout(() => {
          if (submitButton.disabled) {
            submitButton.disabled = false;
            submitButton.innerHTML =
              '<i class="fas fa-save mr-2"></i>Sauvegarder les modifications';
          }
        }, 10000);
      });
    }

    // Animações de foco nos inputs
    const inputs = document.querySelectorAll('.form-input');
    inputs.forEach((input) => {
      input.addEventListener('focus', function () {
        this.parentElement.classList.add('focused');
      });

      input.addEventListener('blur', function () {
        this.parentElement.classList.remove('focused');
      });
    });
  });
</script>

{% endblock %}
