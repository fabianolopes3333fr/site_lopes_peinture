{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Dashboard administratif - LOPES PEINTURE - Gestion des projets de peinture et services"
    />
    <meta name="keywords" content="dashboard, peinture, administration, projets, LOPES PEINTURE" />
    <meta name="author" content="LOPES PEINTURE" />
    <title>{% block title %}Dashboard - LOPES PEINTURE{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}" />

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'config/css/dashboard.css' %}" />
    {% tailwind_css %}

    <!-- Font Awesome -->
    <script
      defer
      src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"
      crossorigin="anonymous"
    ></script>

    <!-- Custom CSS Variables -->
    <style>
      :root {
        --primary-color: #1e40af;
        --secondary-color: #3b82f6;
        --accent-color: #f59e0b;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --dark-color: #1f2937;
        --light-color: #f8fafc;
        --sidebar-width: 256px;
        --sidebar-collapsed-width: 64px;
        --header-height: 70px;
        --footer-height: 60px;
      }

      /* Prevenir overflow horizontal */
      html,
      body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      .sidebar-collapsed {
        width: var(--sidebar-collapsed-width) !important;
      }

      .sidebar-collapsed .sidebar-text {
        display: none;
      }

      .sidebar-collapsed .sidebar-icon {
        margin: 0 auto;
      }

      /* Ajustar padding dos links quando colapsado */
      .sidebar-collapsed nav a {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
        justify-content: center;
      }

      /* Esconder texto do header quando colapsado */
      .sidebar-collapsed .sidebar-header-text {
        display: none;
      }

      .sidebar-collapsed .sidebar-header-icon {
        display: block;
        text-align: center;
      }

      .content-expanded {
        margin-left: var(--sidebar-collapsed-width);
        width: calc(100vw - var(--sidebar-collapsed-width));
      }

      .content-normal {
        margin-left: var(--sidebar-width);
        width: calc(100vw - var(--sidebar-width));
      }

      /* Responsivo */
      @media (max-width: 1024px) {
        .content-normal,
        .content-expanded {
          margin-left: 0;
          width: 100vw;
        }
      }

      /* Tooltip para sidebar colapsada */
      .sidebar-tooltip {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        margin-left: 0.5rem;
        background: #1f2937;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 1000;
        pointer-events: none;
      }

      .sidebar-collapsed nav a:hover .sidebar-tooltip {
        opacity: 1;
        visibility: visible;
      }

      /* Arrow do tooltip */
      .sidebar-tooltip::before {
        content: '';
        position: absolute;
        left: -4px;
        top: 50%;
        transform: translateY(-50%);
        border: 4px solid transparent;
        border-right-color: #1f2937;
      }
    </style>
  </head>
  <body class="h-full bg-gray-50 font-sans antialiased">
    {% include 'components/logout.html' %}

    <!-- Header Fixo -->
    <header
      class="fixed top-0 left-0 right-0 z-50 bg-white shadow-lg border-b border-gray-200"
      style="height: var(--header-height)"
    >
      <div class="h-full px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-full">
          <!-- Logo e Toggle Sidebar -->
          <div class="flex items-center space-x-4">
            <!-- Toggle Sidebar Button -->
            <button
              id="sidebarToggle"
              class="p-2 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <i class="fas fa-bars text-xl"></i>
            </button>

            <!-- Logo -->
            <a href="/" class="flex items-center space-x-3">
              <img
                src="{% static 'base/images/logo-220x80-preto.svg' %}"
                class="h-10 w-auto"
                alt="LOPES PEINTURE"
                loading="lazy"
              />
              <span class="text-xl font-bold text-blue-600 hidden sm:block"></span>
            </a>
          </div>

          <!-- User Menu -->
          <div class="flex items-center space-x-4">
            <!-- Notifications -->
            <button
              class="p-2 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg transition-all duration-200 relative"
            >
              <i class="fas fa-bell text-lg"></i>
              <span
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                >3</span
              >
            </button>

            <!-- User Info -->
            <div class="hidden md:flex items-center space-x-3 text-gray-700">
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-blue-600 text-sm"></i>
              </div>
              <span class="text-sm font-medium"
                >{{user.first_name|default:"Utilisateur"}} {{user.last_name}}</span
              >
            </div>

            <!-- Logout Button -->
            <button
              data-bs-toggle="modal" href="#dialog"
              
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
            >
              <i class="fas fa-sign-out-alt mr-2"></i>
              <span class="hidden sm:inline">Déconnexion</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="fixed left-0 z-40 bg-white shadow-xl border-r border-gray-200 transition-all duration-300 ease-in-out"
      style="top: var(--header-height); bottom: var(--footer-height); width: var(--sidebar-width)"
    >
      <!-- Sidebar Header -->
      <div class="p-6 border-b border-gray-200">
        <div class="sidebar-header-text">
          <h2 class="text-lg font-semibold text-gray-800">Menu Principal</h2>
        </div>
        <div class="sidebar-header-icon hidden">
          <i class="fas fa-th-large text-gray-600 text-xl"></i>
        </div>
      </div>

      <!-- Sidebar Navigation -->
      <nav class="flex-1 px-4 py-6 space-y-2">
        <a
          href="{% url 'pages:home' %}"
          class="relative flex items-center px-4 py-3 text-sm font-medium text-amber-700 bg-amber-50 border border-amber-200 rounded-lg hover:bg-amber-100 transition-colors duration-200 group"
        >
          <i
            class="sidebar-icon fas fa-arrow-left mr-3 text-amber-600 group-hover:text-amber-700 flex-shrink-0"
          ></i>
          <span class="sidebar-text">Retour au Site</span>
          <div class="sidebar-tooltip">Retour au Site</div>
        </a>

        <a
          href="{% url 'config:painel' %}"
          class="relative flex items-center px-4 py-3 text-sm font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors duration-200 group"
        >
          <i
            class="sidebar-icon fas fa-tachometer-alt mr-3 text-blue-600 group-hover:text-blue-700 flex-shrink-0"
          ></i>
          <span class="sidebar-text">Tableau de Bord</span>
          <div class="sidebar-tooltip">Tableau de Bord</div>
        </a>

        <a
          href="#"
          class="relative flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors duration-200 group"
        >
          <i
            class="sidebar-icon fas fa-file-alt mr-3 text-gray-500 group-hover:text-blue-600 flex-shrink-0"
          ></i>
          <span class="sidebar-text">Rapports</span>
          <div class="sidebar-tooltip">Rapports</div>
        </a>

        <a
          href="#"
          class="relative flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors duration-200 group"
        >
          <i
            class="sidebar-icon fas fa-users mr-3 text-gray-500 group-hover:text-blue-600 flex-shrink-0"
          ></i>
          <span class="sidebar-text">Utilisateurs</span>
          <div class="sidebar-tooltip">Utilisateurs</div>
        </a>

        <a
          href="#"
          class="relative flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors duration-200 group"
        >
          <i
            class="sidebar-icon fas fa-paint-brush mr-3 text-gray-500 group-hover:text-blue-600 flex-shrink-0"
          ></i>
          <span class="sidebar-text">Projets</span>
          <div class="sidebar-tooltip">Projets</div>
        </a>

        <a
          href="{% url 'config:settings' %}"
          class="relative flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors duration-200 group"
        >
          <i
            class="sidebar-icon fas fa-cog mr-3 text-gray-500 group-hover:text-blue-600 flex-shrink-0"
          ></i>
          <span class="sidebar-text">Paramètres</span>
          <div class="sidebar-tooltip">Paramètres</div>
        </a>
      </nav>

      <!-- Sidebar Footer -->
      <div class="p-4 border-t border-gray-200">
        <div class="flex items-center space-x-3 text-sm text-gray-600">
          <div
            class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0"
          >
            <i class="fas fa-circle text-green-500 text-xs"></i>
          </div>
          <span class="sidebar-text">Système en ligne</span>
        </div>
      </div>
    </aside>

    <!-- Overlay para mobile -->
    <div
      id="sidebarOverlay"
      class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden transition-opacity duration-300"
    ></div>

    <!-- Main Content -->
    <main
      id="mainContent"
      class="transition-all duration-300 ease-in-out content-normal overflow-hidden"
      style="padding-top: var(--header-height); padding-bottom: var(--footer-height)"
    >
      <!-- Content Container -->
      <div class="h-full overflow-y-auto overflow-x-hidden">
        <div class="mx-2.5 my-6 lg:mx-4">
          <!-- Messages -->
          {% if messages %}
          <div class="mb-6">
            {% for message in messages %}
            <div
              class="alert alert-{{ message.tags }} bg-{{ message.tags }}-50 border border-{{ message.tags }}-200 text-{{ message.tags }}-800 px-4 py-3 rounded-lg mb-3"
              role="alert"
            >
              <div class="flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                {{ message }}
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <!-- Page Content -->
          <div
            class="bg-white rounded-lg shadow-sm border border-gray-200 min-h-[calc(100vh-140px)]"
          >
            {% block content %}
            
            {% endblock %}
          </div>
        </div>
      </div>
    </main>

    <!-- Footer Fixo -->
    <footer
      class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200"
      style="height: var(--footer-height)"
    >
      <div class="h-full px-4 sm:px-6 lg:px-8 flex items-center justify-between">
        <div class="text-sm text-gray-600">© 2024 LOPES PEINTURE. Tous droits réservés.</div>
        <div class="hidden sm:flex items-center space-x-4 text-sm text-gray-600">
          <span>Version 1.0.0</span>
          <span>•</span>
          <a href="#" class="hover:text-blue-600 transition-colors duration-200">Support</a>
          <span>•</span>
          <a href="#" class="hover:text-blue-600 transition-colors duration-200">Documentation</a>
        </div>
      </div>
    </footer>

    <!-- JavaScript -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        let sidebarCollapsed = false;
        let isMobile = window.innerWidth < 1024;

        // Toggle Sidebar Function
        function toggleSidebar() {
          if (isMobile) {
            // Mobile: Show/Hide sidebar with overlay
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
          } else {
            // Desktop: Collapse/Expand sidebar
            sidebarCollapsed = !sidebarCollapsed;

            if (sidebarCollapsed) {
              sidebar.classList.add('sidebar-collapsed');
              sidebar.querySelector('.sidebar-header-text').style.display = 'none';
              sidebar.querySelector('.sidebar-header-icon').style.display = 'block';
              mainContent.classList.remove('content-normal');
              mainContent.classList.add('content-expanded');
            } else {
              sidebar.classList.remove('sidebar-collapsed');
              sidebar.querySelector('.sidebar-header-text').style.display = 'block';
              sidebar.querySelector('.sidebar-header-icon').style.display = 'none';
              mainContent.classList.remove('content-expanded');
              mainContent.classList.add('content-normal');
            }
          }
        }

        // Event Listeners
        sidebarToggle.addEventListener('click', toggleSidebar);

        // Close sidebar on overlay click (mobile)
        sidebarOverlay.addEventListener('click', function () {
          if (isMobile) {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
          }
        });

        // Handle window resize
        window.addEventListener('resize', function () {
          const newIsMobile = window.innerWidth < 1024;

          if (newIsMobile !== isMobile) {
            isMobile = newIsMobile;

            if (isMobile) {
              // Switch to mobile mode
              sidebar.classList.remove('sidebar-collapsed');
              sidebar.classList.add('-translate-x-full');
              sidebar.querySelector('.sidebar-header-text').style.display = 'block';
              sidebar.querySelector('.sidebar-header-icon').style.display = 'none';
              mainContent.classList.remove('content-expanded', 'content-normal');
              sidebarOverlay.classList.add('hidden');
              sidebarCollapsed = false;
            } else {
              // Switch to desktop mode
              sidebar.classList.remove('-translate-x-full');
              sidebarOverlay.classList.add('hidden');

              if (sidebarCollapsed) {
                sidebar.classList.add('sidebar-collapsed');
                sidebar.querySelector('.sidebar-header-text').style.display = 'none';
                sidebar.querySelector('.sidebar-header-icon').style.display = 'block';
                mainContent.classList.add('content-expanded');
              } else {
                mainContent.classList.add('content-normal');
              }
            }
          }
        });

        // Initialize mobile state
        if (isMobile) {
          sidebar.classList.add('-translate-x-full');
          mainContent.classList.remove('content-normal', 'content-expanded');
        }

        // Close mobile sidebar on escape key
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && isMobile && !sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
          }
        });

        // Prevent body scroll when mobile sidebar is open
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              if (isMobile) {
                if (sidebar.classList.contains('-translate-x-full')) {
                  document.body.style.overflow = '';
                } else {
                  document.body.style.overflow = 'hidden';
                }
              } else {
                document.body.style.overflow = '';
              }
            }
          });
        });

        observer.observe(sidebar, { attributes: true });

        // Handle command buttons (for modals, etc.)
        document.addEventListener('click', function (e) {
          const commandButton = e.target.closest('[command]');
          if (commandButton) {
            const command = commandButton.getAttribute('command');
            const commandFor = commandButton.getAttribute('commandfor');

            if (command === 'show-modal' && commandFor) {
              const modal = document.getElementById(commandFor);
              if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
              }
            }
          }
        });

        // Auto-hide alerts after 5 seconds
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function (alert) {
          setTimeout(function () {
            alert.style.transition = 'opacity 0.5s ease-out';
            alert.style.opacity = '0';
            setTimeout(function () {
              alert.remove();
            }, 500);
          }, 5000);
        });

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(function (anchor) {
          anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
              target.scrollIntoView({
                behavior: 'smooth',
                block: 'start',
              });
            }
          });
        });

        // Add loading state to buttons
        document.addEventListener('click', function (e) {
          const button = e.target.closest('button[type="submit"], .btn-loading');
          if (button && !button.disabled) {
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Chargement...';

            // Reset after 3 seconds (fallback)
            setTimeout(function () {
              button.disabled = false;
              button.innerHTML = originalText;
            }, 3000);
          }
        });

        // Initialize tooltips for collapsed sidebar
        function initTooltips() {
          const tooltipElements = document.querySelectorAll('.sidebar-tooltip');
          tooltipElements.forEach(function (tooltip) {
            const parent = tooltip.parentElement;

            parent.addEventListener('mouseenter', function () {
              if (sidebar.classList.contains('sidebar-collapsed')) {
                tooltip.style.opacity = '1';
                tooltip.style.visibility = 'visible';
              }
            });

            parent.addEventListener('mouseleave', function () {
              tooltip.style.opacity = '0';
              tooltip.style.visibility = 'hidden';
            });
          });
        }

        initTooltips();

        // Performance optimization: Debounce resize events
        let resizeTimeout;
        window.addEventListener('resize', function () {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(function () {
            // Additional resize logic if needed
          }, 250);
        });

        // Add focus management for accessibility
        document.addEventListener('keydown', function (e) {
          // Tab navigation improvements
          if (e.key === 'Tab') {
            const focusableElements = document.querySelectorAll(
              'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if (e.shiftKey && document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            } else if (!e.shiftKey && document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        });

        // Console log for debugging (remove in production)
        console.log('Dashboard initialized successfully');
        console.log('Mobile mode:', isMobile);
        console.log('Sidebar collapsed:', sidebarCollapsed);
      });

      // Additional utility functions
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 z-50 bg-${type}-50 border border-${type}-200 text-${type}-800 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
        notification.innerHTML = `
                  <div class="flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    ${message}
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-${type}-600 hover:text-${type}-800">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                `;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.remove('translate-x-full');
        }, 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
          notification.classList.add('translate-x-full');
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      // Export for global use
      window.dashboardUtils = {
        showNotification,
        toggleSidebar: function () {
          document.getElementById('sidebarToggle').click();
        },
      };
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
